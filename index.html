<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ekskul Robotik & Pemrograman - SMK TI Bali Global Karangasem</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Cloudinary SDK -->
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.min.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Particle.js -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    
    <!-- Anime.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    
    <!-- Howler.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <!-- QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0f1e 0%, #1a1f35 50%, #0d1b2a 100%);
            color: #fff;
            position: relative;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background: #1a1f35;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #00d4ff, #0a5cff);
            border-radius: 4px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.8)); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); filter: drop-shadow(0 0 20px gold); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .roboto-font {
            font-family: 'Orbitron', sans-serif;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.2);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5),
                         0 0 20px rgba(0, 212, 255, 0.3),
                         0 0 30px rgba(0, 212, 255, 0.2);
        }

        .gradient-bg {
            background: linear-gradient(45deg, #00d4ff, #0a5cff);
            background-size: 200% 200%;
            animation: shimmer 3s linear infinite;
        }

        .floating {
            animation: float 4s ease-in-out infinite;
        }

        .glowing {
            animation: glow 2s ease-in-out infinite;
        }

        .hover-scale {
            transition: transform 0.2s ease;
        }

        .hover-scale:hover {
            transform: scale(1.03);
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0f1e;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.3s ease;
        }

        .loading-content {
            text-align: center;
            padding: 20px;
            max-width: 90%;
            animation: slideIn 0.5s ease;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            margin: 0 auto;
            animation: slideIn 0.3s ease;
        }

        input, select, textarea {
            color: #000000 !important;
            background-color: #ffffff !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            font-size: 16px !important;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #00d4ff !important;
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2) !important;
            transform: scale(1.01);
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 90%;
        }

        .toast {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 16px 20px;
            color: #1a1a1a;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
            border-left: 4px solid #00d4ff;
        }

        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            animation: pulse 2s infinite;
        }

        .notification-panel {
            position: absolute;
            top: 50px;
            right: 0;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            background: rgba(26, 31, 53, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            z-index: 50;
            display: none;
        }

        .notification-panel.show {
            display: block;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(-5px);
        }

        .notification-item.unread {
            background: rgba(0, 212, 255, 0.1);
        }

        .developer-badge {
            background: linear-gradient(45deg, #ff00ff, #00ffff, #ff00ff);
            background-size: 200% 200%;
            animation: shimmer 3s linear infinite;
            color: #000;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: 6px;
            border: 1px solid white;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ffd700, #ffa500);
            color: #000;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: 6px;
        }

        .level-badge {
            background: linear-gradient(45deg, #00d4ff, #0a5cff);
            color: white;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .level-badge:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px #00d4ff);
        }

        .medal-1 {
            background: linear-gradient(45deg, #ffd700, #ffa500);
            color: #000;
            font-weight: bold;
        }

        .medal-2 {
            background: linear-gradient(45deg, #c0c0c0, #a0a0a0);
            color: #000;
            font-weight: bold;
        }

        .medal-3 {
            background: linear-gradient(45deg, #cd7f32, #b87333);
            color: #fff;
            font-weight: bold;
        }

        .hamburger {
            width: 30px;
            height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hamburger span {
            width: 100%;
            height: 3px;
            background: white;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 8px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -8px);
        }

        .mobile-menu {
            position: fixed;
            top: 60px;
            right: -100%;
            width: 80%;
            max-width: 300px;
            height: calc(100vh - 60px);
            background: rgba(26, 31, 53, 0.98);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transition: right 0.3s ease;
            z-index: 45;
            overflow-y: auto;
            padding: 20px;
        }

        .mobile-menu.show {
            right: 0;
        }

        .mobile-menu-item {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .mobile-menu-item:hover {
            background: rgba(0, 212, 255, 0.1);
            transform: translateX(10px);
        }

        .mobile-menu-item i {
            width: 25px;
            color: #00d4ff;
        }

        .dev-power-section {
            background: linear-gradient(45deg, rgba(255,0,255,0.1), rgba(0,255,255,0.1));
            border: 1px solid #ff00ff;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 20px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.1);
        }

        #certificate-template {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
            background: white;
            color: black;
            padding: 40px;
            border: 20px solid #00d4ff;
            border-radius: 20px;
            text-align: center;
            font-family: 'Poppins', sans-serif;
        }

        .photo-preview-container {
            position: relative;
            width: 100%;
            min-height: 150px;
            border: 2px dashed rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .photo-preview-container:hover {
            border-color: #00d4ff;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
        }

        .photo-preview-placeholder {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
        }

        .photo-preview-placeholder i {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .camera-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: linear-gradient(45deg, #00d4ff, #0a5cff);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .camera-btn:hover {
            transform: scale(1.1) rotate(15deg);
        }

        .action-btn {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            min-width: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn.edit {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .action-btn.edit:hover {
            background: rgba(0, 212, 255, 0.3);
            transform: scale(1.1);
        }

        .action-btn.delete {
            background: rgba(255, 75, 75, 0.2);
            color: #ff4b4b;
        }

        .action-btn.delete:hover {
            background: rgba(255, 75, 75, 0.3);
            transform: scale(1.1);
        }

        .action-btn.dev {
            background: rgba(255, 0, 255, 0.2);
            color: #ff00ff;
        }

        .action-btn.dev:hover {
            background: rgba(255, 0, 255, 0.3);
            transform: scale(1.1);
        }

        .action-btn.admin {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
        }

        .action-btn.admin:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: scale(1.1);
        }

        .badge-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .badge-item:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 15px gold);
        }

        .badge-equipped {
            border: 3px solid gold;
            position: relative;
        }

        .badge-equipped::after {
            content: '‚úì';
            position: absolute;
            top: -5px;
            right: -5px;
            background: gold;
            color: black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }

        .chat-message {
            display: flex;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }

        .chat-message.own {
            justify-content: flex-end;
        }

        .chat-bubble {
            max-width: 70%;
            padding: 10px 16px;
            border-radius: 18px;
            background: rgba(255,255,255,0.1);
            position: relative;
        }

        .chat-message.own .chat-bubble {
            background: linear-gradient(45deg, #00d4ff, #0a5cff);
        }

        .chat-time {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .mystery-box {
            width: 200px;
            height: 200px;
            background: linear-gradient(45deg, #ffd700, #ffa500, #ff6b6b, #00d4ff);
            background-size: 300% 300%;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto;
            animation: shimmer 3s linear infinite;
        }

        .mystery-box:hover {
            transform: scale(1.1) rotate(5deg);
            filter: drop-shadow(0 0 30px gold);
        }

        .mystery-box.shake {
            animation: shake 0.5s ease;
        }

        .mystery-box.cost {
            position: relative;
        }

        .mystery-box.cost::after {
            content: '‚≠ê 50';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            color: gold;
            white-space: nowrap;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .attendance-table th {
            background: rgba(0, 212, 255, 0.2);
            padding: 12px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
        }

        .attendance-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
        }

        .profile-modal-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #00d4ff;
            margin: 0 auto 20px;
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            .desktop-menu {
                display: none !important;
            }
            .mobile-menu-button {
                display: flex !important;
            }
            .mobile-menu {
                display: block;
            }
        }
        
        @media (min-width: 769px) {
            .desktop-menu {
                display: flex !important;
            }
            .mobile-menu-button {
                display: none !important;
            }
            .mobile-menu {
                display: none;
            }
        }
        
        @media (max-width: 640px) {
            .modal-content { padding: 16px; width: 95%; }
            button, .action-btn, [onclick] { min-height: 44px; }
            .notification-panel { width: 90%; right: 5%; max-width: 320px; }
            h1 { font-size: 1.5rem !important; }
            .text-6xl { font-size: 3rem !important; }
            .text-5xl { font-size: 2rem !important; }
            .attendance-table { font-size: 12px; }
            .chart-container { height: 250px; }
            .glass-effect { padding-left: 12px !important; padding-right: 12px !important; }
            h1.roboto-font { font-size: 18px !important; }
            .text-6xl { font-size: 40px !important; }
            .text-4xl { font-size: 24px !important; }
            .grid.grid-cols-3 { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .glass-card { padding: 10px !important; }
            .glass-card .text-xl { font-size: 16px !important; }
            .glass-card .text-xs { font-size: 9px !important; }
            .grid-cols-2 { grid-template-columns: repeat(2, 1fr); gap: 6px; }
            .gradient-bg { font-size: 14px !important; padding: 8px 12px !important; }
            footer .text-sm { font-size: 10px !important; }
            .modal-content { width: 95% !important; padding: 12px !important; }
            input, select, textarea { font-size: 16px !important; padding: 8px !important; }
            .notification-panel { width: 280px !important; right: 5px !important; top: 45px !important; }
            .attendance-table { font-size: 11px !important; }
            .attendance-table th, .attendance-table td { padding: 4px !important; }
            .chart-container { height: 180px !important; padding: 8px !important; }
            .camera-btn { width: 36px !important; height: 36px !important; }
            .photo-preview-container { min-height: 120px !important; }
            .photo-preview { max-height: 150px !important; }
            .action-btn { padding: 4px 8px !important; font-size: 12px !important; min-height: 36px !important; min-width: 36px !important; }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>

    <div id="loading-screen">
        <div class="loading-content">
            <div class="loader"></div>
            <h3 class="text-xl font-bold mb-2 roboto-font neon-text">Ekskul Robotik</h3>
            <p class="text-gray-400" id="loading-progress">0%</p>
            <p class="text-sm text-gray-500 mt-2">SMK TI Bali Global Karangasem</p>
        </div>
    </div>

    <div id="app" class="relative z-10 min-h-screen"></div>
    <div id="toast-container" class="toast-container"></div>
    <div id="notification-panel" class="notification-panel"></div>
    <div id="certificate-template"></div>

    <script>
        // ==================== CLOUDINARY CONFIG ====================
        const CLOUDINARY_CLOUD_NAME = 'drhb17arq';
        const CLOUDINARY_API_KEY = '294548853871465';
        const CLOUDINARY_UPLOAD_PRESET = 'ekskul_robotik_profile';

        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAkLcYEkg4Yp16pbUCIlH7012Ut4Xi02ks",
            authDomain: "absensii-e6e72.firebaseapp.com",
            projectId: "absensii-e6e72",
            storageBucket: "absensii-e6e72.firebasestorage.app",
            messagingSenderId: "556643295146",
            appId: "1:556643295146:web:7102ef592a2b04b29615d3"
        };

        // Initialize Firebase
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            
            db.enablePersistence()
                .catch(err => console.log('Persistence error:', err));
                
            console.log('Firebase initialized');
        } catch (error) {
            console.error('Firebase init error:', error);
        }

        moment.locale('id');

        // ==================== KONSTANTA ====================
        const DEV_EMAIL = "saputraamanah999@gmail.com";
        const DEV_PASSWORD = "saputra123";

        // Badge definitions (Level 1-100)
        const badges = [
            // Level badges (1-100)
            ...Array.from({ length: 100 }, (_, i) => ({
                id: `level_${i + 1}`,
                name: `Level ${i + 1}`,
                icon: i < 10 ? 'üå±' : i < 25 ? 'üî•' : i < 50 ? '‚ö°' : i < 75 ? 'üéñÔ∏è' : 'üèÜ',
                desc: `Mencapai level ${i + 1}`,
                requirement: `${(i + 1) * 10} kehadiran`,
                target: (i + 1) * 10,
                color: i < 10 ? '#4CAF50' : i < 25 ? '#FF9800' : i < 50 ? '#FFC107' : i < 75 ? '#9C27B0' : '#FFD700',
                level: i + 1,
                points: (i + 1) * 10
            })),
            // Special badges
            { id: 'beginner', name: 'Pemula', icon: 'üå±', desc: 'Absen pertama', target: 1, color: '#4CAF50', level: 1, points: 10 },
            { id: 'active', name: 'Aktif', icon: 'üî•', desc: '10 kehadiran', target: 10, color: '#FF9800', level: 2, points: 50 },
            { id: 'super_active', name: 'Super Aktif', icon: '‚ö°', desc: '25 kehadiran', target: 25, color: '#FFC107', level: 3, points: 100 },
            { id: 'veteran', name: 'Veteran', icon: 'üéñÔ∏è', desc: '50 kehadiran', target: 50, color: '#9C27B0', level: 4, points: 200 },
            { id: 'legend', name: 'Legenda', icon: 'üèÜ', desc: '100 kehadiran', target: 100, color: '#FFD700', level: 5, points: 500 },
            { id: 'project_master', name: 'Master Proyek', icon: 'üíª', desc: '3 proyek', target: 3, color: '#2196F3', level: 3, points: 150 },
            { id: 'perfect_attendance', name: 'Sempurna', icon: 'üåü', desc: 'Absen 30 hari berturut-turut', target: 30, color: '#FF69B4', level: 10, points: 1000 },
            { id: 'early_bird', name: 'Rajin Pagi', icon: 'üê¶', desc: 'Absen pagi 10x', target: 10, color: '#FFA500', level: 2, points: 50 },
            { id: 'night_owl', name: 'Burung Hantu', icon: 'ü¶â', desc: 'Absen malam 10x', target: 10, color: '#800080', level: 2, points: 50 },
            { id: 'social_butterfly', name: 'Sosialita', icon: 'ü¶ã', desc: '100 komentar', target: 100, color: '#FF1493', level: 5, points: 500 },
            { id: 'master_chatter', name: 'Master Chat', icon: 'üí¨', desc: '500 pesan chat', target: 500, color: '#00CED1', level: 10, points: 1000 },
            { id: 'project_creator', name: 'Kreator', icon: 'üé®', desc: '10 proyek', target: 10, color: '#32CD32', level: 5, points: 500 },
            { id: 'millionaire', name: 'Miliarder', icon: 'üí∞', desc: '10000 points', target: 10000, color: '#FFD700', level: 20, points: 5000 },
            { id: 'friendship', name: 'Sahabat', icon: 'ü§ù', desc: 'Follow 50 orang', target: 50, color: '#FF69B4', level: 5, points: 500 },
            { id: 'popular', name: 'Populer', icon: '‚≠ê', desc: '100 followers', target: 100, color: '#FFD700', level: 10, points: 1000 },
            { id: 'storyteller', name: 'Pendongeng', icon: 'üìñ', desc: '10 story', target: 10, color: '#9C27B0', level: 3, points: 150 },
            { id: 'photographer', name: 'Fotografer', icon: 'üì∏', desc: '20 foto upload', target: 20, color: '#2196F3', level: 4, points: 200 },
            { id: 'veteran_chatter', name: 'Veteran Chat', icon: 'üó£Ô∏è', desc: '1000 pesan chat', target: 1000, color: '#FF4500', level: 20, points: 2000 },
            { id: 'legend_chatter', name: 'Legenda Chat', icon: 'üëë', desc: '5000 pesan chat', target: 5000, color: '#FFD700', level: 50, points: 5000 },
            { id: 'super_creator', name: 'Super Kreator', icon: 'üéØ', desc: '50 proyek', target: 50, color: '#FF4500', level: 25, points: 2500 }
        ];

        // Mission definitions (100+ missions)
        const missions = [
            // Level missions
            ...Array.from({ length: 100 }, (_, i) => ({
                id: `mission_level_${i + 1}`,
                name: `Misi Level ${i + 1}`,
                icon: i < 10 ? 'üå±' : i < 25 ? 'üî•' : i < 50 ? '‚ö°' : i < 75 ? 'üéñÔ∏è' : 'üèÜ',
                requirement: (i + 1) * 10,
                reward: `level_${i + 1}`,
                desc: `Capai ${(i + 1) * 10} kehadiran`,
                points: (i + 1) * 50,
                type: 'attendance'
            })),
            // Special missions
            { id: 'mission_project_master', name: 'Master Proyek', icon: 'üíª', requirement: 3, reward: 'project_master', desc: 'Buat 3 proyek', points: 150, type: 'project' },
            { id: 'mission_perfect_attendance', name: 'Sempurna', icon: 'üåü', requirement: 30, reward: 'perfect_attendance', desc: 'Absen 30 hari berturut-turut', points: 1000, type: 'consecutive' },
            { id: 'mission_early_bird', name: 'Rajin Pagi', icon: 'üê¶', requirement: 10, reward: 'early_bird', desc: 'Absen pagi 10x', points: 50, type: 'early' },
            { id: 'mission_night_owl', name: 'Burung Hantu', icon: 'ü¶â', requirement: 10, reward: 'night_owl', desc: 'Absen malam 10x', points: 50, type: 'night' },
            { id: 'mission_social_butterfly', name: 'Sosialita', icon: 'ü¶ã', requirement: 100, reward: 'social_butterfly', desc: '100 komentar', points: 500, type: 'comment' },
            { id: 'mission_master_chatter', name: 'Master Chat', icon: 'üí¨', requirement: 500, reward: 'master_chatter', desc: '500 pesan chat', points: 1000, type: 'chat' },
            { id: 'mission_project_creator', name: 'Kreator', icon: 'üé®', requirement: 10, reward: 'project_creator', desc: '10 proyek', points: 500, type: 'project' },
            { id: 'mission_millionaire', name: 'Miliarder', icon: 'üí∞', requirement: 10000, reward: 'millionaire', desc: 'Kumpulkan 10000 points', points: 5000, type: 'points' },
            { id: 'mission_friendship', name: 'Sahabat', icon: 'ü§ù', requirement: 50, reward: 'friendship', desc: 'Follow 50 orang', points: 500, type: 'follow' },
            { id: 'mission_popular', name: 'Populer', icon: '‚≠ê', requirement: 100, reward: 'popular', desc: '100 followers', points: 1000, type: 'follower' },
            { id: 'mission_storyteller', name: 'Pendongeng', icon: 'üìñ', requirement: 10, reward: 'storyteller', desc: '10 story', points: 150, type: 'story' },
            { id: 'mission_photographer', name: 'Fotografer', icon: 'üì∏', requirement: 20, reward: 'photographer', desc: '20 foto upload', points: 200, type: 'photo' },
            { id: 'mission_veteran_chatter', name: 'Veteran Chat', icon: 'üó£Ô∏è', requirement: 1000, reward: 'veteran_chatter', desc: '1000 pesan chat', points: 2000, type: 'chat' },
            { id: 'mission_legend_chatter', name: 'Legenda Chat', icon: 'üëë', requirement: 5000, reward: 'legend_chatter', desc: '5000 pesan chat', points: 5000, type: 'chat' },
            { id: 'mission_super_creator', name: 'Super Kreator', icon: 'üéØ', requirement: 50, reward: 'super_creator', desc: '50 proyek', points: 2500, type: 'project' }
        ];

        // Mystery Box Items
        const mysteryBoxItems = [
            { type: 'badge', id: 'beginner', name: 'Badge Pemula', icon: 'üå±', rare: 'common', cost: 10, points: 10 },
            { type: 'badge', id: 'active', name: 'Badge Aktif', icon: 'üî•', rare: 'uncommon', cost: 50, points: 50 },
            { type: 'badge', id: 'super_active', name: 'Badge Super Aktif', icon: '‚ö°', rare: 'rare', cost: 100, points: 100 },
            { type: 'badge', id: 'veteran', name: 'Badge Veteran', icon: 'üéñÔ∏è', rare: 'epic', cost: 200, points: 200 },
            { type: 'badge', id: 'legend', name: 'Badge Legenda', icon: 'üèÜ', rare: 'legendary', cost: 500, points: 500 },
            { type: 'badge', id: 'project_master', name: 'Badge Master Proyek', icon: 'üíª', rare: 'rare', cost: 150, points: 150 },
            { type: 'badge', id: 'perfect_attendance', name: 'Badge Sempurna', icon: 'üåü', rare: 'legendary', cost: 1000, points: 1000 },
            { type: 'badge', id: 'early_bird', name: 'Badge Rajin Pagi', icon: 'üê¶', rare: 'uncommon', cost: 50, points: 50 },
            { type: 'badge', id: 'night_owl', name: 'Badge Burung Hantu', icon: 'ü¶â', rare: 'uncommon', cost: 50, points: 50 },
            { type: 'badge', id: 'social_butterfly', name: 'Badge Sosialita', icon: 'ü¶ã', rare: 'epic', cost: 500, points: 500 },
            { type: 'badge', id: 'master_chatter', name: 'Badge Master Chat', icon: 'üí¨', rare: 'legendary', cost: 1000, points: 1000 },
            { type: 'badge', id: 'project_creator', name: 'Badge Kreator', icon: 'üé®', rare: 'epic', cost: 500, points: 500 },
            { type: 'badge', id: 'millionaire', name: 'Badge Miliarder', icon: 'üí∞', rare: 'legendary', cost: 5000, points: 5000 },
            { type: 'badge', id: 'friendship', name: 'Badge Sahabat', icon: 'ü§ù', rare: 'epic', cost: 500, points: 500 },
            { type: 'badge', id: 'popular', name: 'Badge Populer', icon: '‚≠ê', rare: 'legendary', cost: 1000, points: 1000 },
            { type: 'badge', id: 'storyteller', name: 'Badge Pendongeng', icon: 'üìñ', rare: 'rare', cost: 150, points: 150 },
            { type: 'badge', id: 'photographer', name: 'Badge Fotografer', icon: 'üì∏', rare: 'rare', cost: 200, points: 200 },
            { type: 'points', amount: 100, name: '100 Points', icon: '‚≠ê', rare: 'common', cost: 10, points: 100 },
            { type: 'points', amount: 500, name: '500 Points', icon: 'üåüüåü', rare: 'uncommon', cost: 50, points: 500 },
            { type: 'points', amount: 1000, name: '1000 Points', icon: 'üåüüåüüåü', rare: 'rare', cost: 100, points: 1000 },
            { type: 'points', amount: 5000, name: '5000 Points', icon: 'üíé', rare: 'epic', cost: 500, points: 5000 },
            { type: 'points', amount: 10000, name: '10000 Points', icon: 'üëë', rare: 'legendary', cost: 1000, points: 10000 },
            { type: 'title', title: 'The Chosen One', name: 'Title Legendaris', icon: 'üëë', rare: 'legendary', cost: 5000, points: 0 },
            { type: 'title', title: 'Master of All', name: 'Title Master', icon: '‚ö°', rare: 'epic', cost: 2000, points: 0 },
            { type: 'title', title: 'The Creator', name: 'Title Creator', icon: 'üé®', rare: 'epic', cost: 1000, points: 0 }
        ];

        const ekstraData = {
            name: "Robotik & Pemrograman",
            school: "SMK TI Bali Global Karangasem",
            description: "Ekskul Robotik & Pemrograman adalah wadah bagi siswa yang ingin mengembangkan kemampuan dalam bidang teknologi, robotika, dan pemrograman.",
            logo: "ü§ñ",
            vision: "Menjadi pusat pengembangan teknologi robotika dan pemrograman tingkat nasional.",
            mission: [
                "Mengembangkan minat dan bakat siswa dalam bidang robotika",
                "Mempersiapkan siswa untuk kompetisi teknologi",
                "Menciptakan inovasi teknologi bermanfaat"
            ]
        };

        const technologies = [
            { name: "Python", icon: "fab fa-python", color: "#3776AB" },
            { name: "JavaScript", icon: "fab fa-js", color: "#F7DF1E" },
            { name: "Arduino", icon: "fas fa-microchip", color: "#00979D" },
            { name: "React", icon: "fab fa-react", color: "#61DAFB" },
            { name: "Node.js", icon: "fab fa-node", color: "#339933" },
            { name: "IoT", icon: "fas fa-wifi", color: "#00A4EF" },
            { name: "AI", icon: "fas fa-brain", color: "#FF6B6B" },
            { name: "Robotics", icon: "fas fa-robot", color: "#FFD700" }
        ];

        // ==================== STATE MANAGEMENT ====================
        let currentUser = null;
        let userData = null;
        let userRole = 'member';
        let currentPage = 'home';
        
        let members = [];
        let attendance = [];
        let attendanceHistory = [];
        let projects = [];
        let schedules = [];
        let notifications = [];
        let teachers = [];
        let chats = [];
        let stories = [];
        let feeds = [];
        let comments = [];
        let follows = [];
        
        let unreadCount = 0;
        let showNotificationPanel = false;
        
        let showLoginModal = false;
        let showRegisterModal = false;
        let showForgotModal = false;
        let showEditProfileModal = false;
        let showAddProjectModal = false;
        let showAddScheduleModal = false;
        let showAddNotificationModal = false;
        let showAddTeacherModal = false;
        let showAddAdminModal = false;
        let showRemoveAdminModal = false;
        let showSetLevelModal = false;
        let showEditProjectModal = false;
        let showEditScheduleModal = false;
        let showEditTeacherModal = false;
        let showAttendanceHistoryModal = false;
        let showLeaderboardModal = false;
        let showDevPowerModal = false;
        let showMissionsModal = false;
        let showBadgeUseModal = false;
        let showQRModal = false;
        let showChatModal = false;
        let showMysteryBoxModal = false;
        let showStoryModal = false;
        let showFeedModal = false;
        
        let selectedProject = null;
        let selectedSchedule = null;
        let selectedTeacher = null;
        let selectedMember = null;
        let selectedBadge = null;
        let selectedStory = null;
        
        let notificationReactions = {};
        let lastRenderTime = 0;
        const RENDER_THROTTLE = 1000;
        
        let attendanceChart = null;
        let leaderboardData = [];
        let userBadges = {};
        let userLevels = {};
        let userMissions = {};
        let userPoints = {};
        let userEquippedBadge = {};
        let userConsecutiveDays = {};
        let userEarlyBird = {};
        let userNightOwl = {};
        let userTitles = {};
        let userFollowers = {};
        let userFollowing = {};
        let userStories = {};

        // Sound effects
        const sounds = {
            levelUp: new Howl({ src: ['https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'] }),
            badge: new Howl({ src: ['https://www.soundjay.com/misc/sounds/bell-ringing-06.mp3'] }),
            click: new Howl({ src: ['https://www.soundjay.com/button/sounds/button-09.mp3'] }),
            success: new Howl({ src: ['https://www.soundjay.com/misc/sounds/bell-ringing-07.mp3'] }),
            error: new Howl({ src: ['https://www.soundjay.com/misc/sounds/buzzer-02.mp3'] }),
            mystery: new Howl({ src: ['https://www.soundjay.com/misc/sounds/magic-chime-01.mp3'] }),
            coin: new Howl({ src: ['https://www.soundjay.com/misc/sounds/coin-01.mp3'] })
        };

        // ==================== FUNGSI HELPER ====================
        function calculateLevel(attendance) {
            if (attendance >= 1000) return { level: 100, title: 'Dewa', icon: 'üëë' };
            if (attendance >= 900) return { level: 90, title: 'Maha Legenda', icon: 'üëë' };
            if (attendance >= 800) return { level: 80, title: 'Super Legenda', icon: 'üëë' };
            if (attendance >= 700) return { level: 70, title: 'Ultra Legenda', icon: 'üëë' };
            if (attendance >= 600) return { level: 60, title: 'Mega Legenda', icon: 'üëë' };
            if (attendance >= 500) return { level: 50, title: 'Hyper Legenda', icon: 'üëë' };
            if (attendance >= 400) return { level: 40, title: 'Grand Legenda', icon: 'üëë' };
            if (attendance >= 300) return { level: 30, title: 'Master Legenda', icon: 'üëë' };
            if (attendance >= 200) return { level: 20, title: 'Expert Legenda', icon: 'üëë' };
            if (attendance >= 100) return { level: 10, title: 'Legenda', icon: 'üèÜ' };
            if (attendance >= 90) return { level: 9, title: 'Ultra Veteran', icon: 'üéØ' };
            if (attendance >= 80) return { level: 8, title: 'Mega Veteran', icon: 'üéØ' };
            if (attendance >= 70) return { level: 7, title: 'Hyper Veteran', icon: 'üéØ' };
            if (attendance >= 60) return { level: 6, title: 'Grand Veteran', icon: 'üéØ' };
            if (attendance >= 50) return { level: 5, title: 'Veteran', icon: 'üéØ' };
            if (attendance >= 40) return { level: 4, title: 'Ultra Aktif', icon: '‚ö°' };
            if (attendance >= 30) return { level: 3, title: 'Mega Aktif', icon: '‚ö°' };
            if (attendance >= 20) return { level: 2, title: 'Hyper Aktif', icon: '‚ö°' };
            if (attendance >= 10) return { level: 1, title: 'Aktif', icon: 'üî•' };
            return { level: 0, title: 'Baru', icon: 'üÜï' };
        }

        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].play();
            }
        }

        function showToast(message, type = 'success') {
            playSound(type === 'success' ? 'success' : type === 'error' ? 'error' : 'click');
            
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas ${icon} text-xl" style="color: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b'}"></i>
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function safeRender() {
            const now = Date.now();
            if (now - lastRenderTime > RENDER_THROTTLE) {
                lastRenderTime = now;
                requestAnimationFrame(() => {
                    renderMainContent();
                });
            }
        }

        // ==================== CLOUDINARY UPLOAD ====================
        window.openCloudinaryUploader = function(callback) {
            cloudinary.openUploadWidget({
                cloudName: CLOUDINARY_CLOUD_NAME,
                uploadPreset: CLOUDINARY_UPLOAD_PRESET,
                apiKey: CLOUDINARY_API_KEY,
                sources: ['local', 'url', 'camera'],
                cropping: true,
                croppingAspectRatio: 1,
                multiple: false,
                styles: {
                    palette: {
                        window: "#1a1f35",
                        windowBorder: "#00d4ff",
                        tabIcon: "#00d4ff",
                        menuIcons: "#ffffff",
                        textDark: "#000000",
                        textLight: "#ffffff",
                        link: "#00d4ff",
                        action: "#0a5cff",
                        error: "#ff4b4b",
                        inProgress: "#00d4ff",
                        complete: "#10b981",
                        sourceBg: "#0a0f1e"
                    }
                }
            }, (error, result) => {
                if (!error && result && result.event === 'success') {
                    callback(result.info.secure_url);
                } else if (error) {
                    showToast('Gagal upload: ' + error.message, 'error');
                }
            });
        };

        window.uploadProfilePhoto = function() {
            openCloudinaryUploader((url) => {
                document.getElementById('profile-preview').src = url;
                document.getElementById('profile-url-input').value = url;
                showToast('Foto berhasil diupload!', 'success');
            });
        };

        window.uploadProjectPhoto = function() {
            openCloudinaryUploader((url) => {
                document.getElementById('project-preview').src = url;
                document.getElementById('project-preview').style.display = 'block';
                document.getElementById('project-placeholder').style.display = 'none';
                document.getElementById('project-image').value = url;
                showToast('Foto proyek berhasil diupload!', 'success');
            });
        };

        window.uploadStoryPhoto = function() {
            openCloudinaryUploader((url) => {
                createStory(url);
            });
        };

        window.uploadFeedPhoto = function() {
            openCloudinaryUploader((url) => {
                document.getElementById('feed-image').value = url;
                document.getElementById('feed-preview').src = url;
                document.getElementById('feed-preview').style.display = 'block';
                document.getElementById('feed-placeholder').style.display = 'none';
            });
        };

        // ==================== QR CODE ====================
        window.generateQRCode = function(text) {
            const qrContainer = document.getElementById('qr-code-container');
            if (!qrContainer) return;
            
            QRCode.toCanvas(qrContainer, text, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#00d4ff',
                    light: '#ffffff'
                }
            }, (error) => {
                if (error) console.error(error);
            });
        };

        window.downloadQRCode = function() {
            const canvas = document.getElementById('qr-code-container');
            if (!canvas) return;
            
            const link = document.createElement('a');
            link.download = `qrcode-${currentUser?.uid}.png`;
            link.href = canvas.toDataURL();
            link.click();
        };

        // ==================== REALTIME LISTENERS ====================
        function setupRealtimeListeners() {
            db.collection('members').onSnapshot((snapshot) => {
                members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                calculateLeaderboard();
                safeRender();
            });

            const today = moment().format('YYYY-MM-DD');
            db.collection('attendance').where('date', '==', today).onSnapshot((snapshot) => {
                attendance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                safeRender();
            });

            db.collection('attendance').orderBy('date', 'desc').onSnapshot((snapshot) => {
                attendanceHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUser) {
                    checkAndAwardBadges(currentUser.uid);
                    updateUserLevel(currentUser.uid);
                    updateMissions(currentUser.uid);
                    checkConsecutiveDays(currentUser.uid);
                    checkEarlyBird(currentUser.uid);
                    checkNightOwl(currentUser.uid);
                }
            });

            db.collection('projects').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                safeRender();
            });

            db.collection('notifications').orderBy('createdAt', 'desc').limit(20).onSnapshot((snapshot) => {
                notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUser) {
                    unreadCount = notifications.filter(n => 
                        !n.readBy || !n.readBy.includes(currentUser.uid)
                    ).length;
                }
                updateNotificationPanel();
            });

            db.collection('badges').onSnapshot((snapshot) => {
                userBadges = {};
                snapshot.docs.forEach(doc => {
                    userBadges[doc.id] = doc.data();
                });
                safeRender();
            });

            db.collection('points').onSnapshot((snapshot) => {
                userPoints = {};
                snapshot.docs.forEach(doc => {
                    userPoints[doc.id] = doc.data().points || 0;
                });
                safeRender();
            });

            db.collection('missions').onSnapshot((snapshot) => {
                userMissions = {};
                snapshot.docs.forEach(doc => {
                    userMissions[doc.id] = doc.data();
                });
                safeRender();
            });

            db.collection('equippedBadges').onSnapshot((snapshot) => {
                userEquippedBadge = {};
                snapshot.docs.forEach(doc => {
                    userEquippedBadge[doc.id] = doc.data().badgeId;
                });
                safeRender();
            });

            db.collection('chats').orderBy('createdAt', 'asc').onSnapshot((snapshot) => {
                chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                safeRender();
            });

            db.collection('stories').orderBy('createdAt', 'desc').limit(50).onSnapshot((snapshot) => {
                stories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                safeRender();
            });

            db.collection('feeds').orderBy('createdAt', 'desc').limit(50).onSnapshot((snapshot) => {
                feeds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                safeRender();
            });

            db.collection('follows').onSnapshot((snapshot) => {
                follows = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                calculateFollowers();
            });

            db.collection('consecutiveDays').onSnapshot((snapshot) => {
                userConsecutiveDays = {};
                snapshot.docs.forEach(doc => {
                    userConsecutiveDays[doc.id] = doc.data().days || 0;
                });
            });

            db.collection('earlyBird').onSnapshot((snapshot) => {
                userEarlyBird = {};
                snapshot.docs.forEach(doc => {
                    userEarlyBird[doc.id] = doc.data().count || 0;
                });
            });

            db.collection('nightOwl').onSnapshot((snapshot) => {
                userNightOwl = {};
                snapshot.docs.forEach(doc => {
                    userNightOwl[doc.id] = doc.data().count || 0;
                });
            });

            db.collection('titles').onSnapshot((snapshot) => {
                userTitles = {};
                snapshot.docs.forEach(doc => {
                    userTitles[doc.id] = doc.data().titles || [];
                });
            });
        }

        function calculateFollowers() {
            userFollowers = {};
            userFollowing = {};
            follows.forEach(f => {
                if (!userFollowers[f.followingId]) userFollowers[f.followingId] = [];
                userFollowers[f.followingId].push(f.followerId);
                
                if (!userFollowing[f.followerId]) userFollowing[f.followerId] = [];
                userFollowing[f.followerId].push(f.followingId);
            });
        }

        // ==================== FUNGSI BADGE ====================
        async function checkAndAwardBadges(userId) {
            if (!userId || userId.startsWith('manual_')) return;
            
            const userAttendance = attendanceHistory.filter(a => a.userId === userId).length;
            const userProjects = projects.filter(p => p.createdBy === userId).length;
            const userChats = chats.filter(c => c.userId === userId).length;
            const userFeeds = feeds.filter(f => f.userId === userId).length;
            const userStoriesCount = stories.filter(s => s.userId === userId).length;
            const userPhotos = 0; // TODO: Track photo uploads
            const userPointsTotal = userPoints[userId] || 0;
            const followersCount = userFollowers[userId]?.length || 0;
            const followingCount = userFollowing[userId]?.length || 0;
            const consecutive = userConsecutiveDays[userId] || 0;
            const earlyBird = userEarlyBird[userId] || 0;
            const nightOwl = userNightOwl[userId] || 0;
            
            let currentBadges = userBadges[userId]?.badges || [];
            const earnedBadges = [];
            
            // Check level badges
            for (let i = 1; i <= 100; i++) {
                const badgeId = `level_${i}`;
                if (userAttendance >= i * 10 && !currentBadges.includes(badgeId)) {
                    earnedBadges.push(badgeId);
                }
            }
            
            // Check special badges
            if (userAttendance >= 1 && !currentBadges.includes('beginner')) earnedBadges.push('beginner');
            if (userAttendance >= 10 && !currentBadges.includes('active')) earnedBadges.push('active');
            if (userAttendance >= 25 && !currentBadges.includes('super_active')) earnedBadges.push('super_active');
            if (userAttendance >= 50 && !currentBadges.includes('veteran')) earnedBadges.push('veteran');
            if (userAttendance >= 100 && !currentBadges.includes('legend')) earnedBadges.push('legend');
            if (userProjects >= 3 && !currentBadges.includes('project_master')) earnedBadges.push('project_master');
            if (consecutive >= 30 && !currentBadges.includes('perfect_attendance')) earnedBadges.push('perfect_attendance');
            if (earlyBird >= 10 && !currentBadges.includes('early_bird')) earnedBadges.push('early_bird');
            if (nightOwl >= 10 && !currentBadges.includes('night_owl')) earnedBadges.push('night_owl');
            if (userChats >= 500 && !currentBadges.includes('master_chatter')) earnedBadges.push('master_chatter');
            if (userProjects >= 10 && !currentBadges.includes('project_creator')) earnedBadges.push('project_creator');
            if (userPointsTotal >= 10000 && !currentBadges.includes('millionaire')) earnedBadges.push('millionaire');
            if (followingCount >= 50 && !currentBadges.includes('friendship')) earnedBadges.push('friendship');
            if (followersCount >= 100 && !currentBadges.includes('popular')) earnedBadges.push('popular');
            if (userStoriesCount >= 10 && !currentBadges.includes('storyteller')) earnedBadges.push('storyteller');
            if (userPhotos >= 20 && !currentBadges.includes('photographer')) earnedBadges.push('photographer');
            if (userChats >= 1000 && !currentBadges.includes('veteran_chatter')) earnedBadges.push('veteran_chatter');
            if (userChats >= 5000 && !currentBadges.includes('legend_chatter')) earnedBadges.push('legend_chatter');
            if (userProjects >= 50 && !currentBadges.includes('super_creator')) earnedBadges.push('super_creator');
            
            if (earnedBadges.length > 0) {
                try {
                    const newBadges = [...currentBadges, ...earnedBadges];
                    
                    await db.collection('badges').doc(userId).set({
                        badges: newBadges,
                        updatedAt: new Date()
                    }, { merge: true });
                    
                    let totalPoints = userPoints[userId] || 0;
                    earnedBadges.forEach(badgeId => {
                        const badge = badges.find(b => b.id === badgeId);
                        totalPoints += badge?.points || 0;
                    });
                    
                    await db.collection('points').doc(userId).set({
                        points: totalPoints,
                        updatedAt: new Date()
                    }, { merge: true });
                    
                    playSound('badge');
                    
                    earnedBadges.forEach(badgeId => {
                        const badge = badges.find(b => b.id === badgeId);
                        if (badge) {
                            showToast(`üéâ Selamat! Anda mendapat badge ${badge.name} ${badge.icon} +${badge.points} points!`, 'success');
                        }
                    });
                    
                    await checkLevelUp(userId);
                    
                } catch (error) {
                    console.error('Error awarding badge:', error);
                }
            }
            
            return earnedBadges;
        }

        window.equipBadge = async (badgeId) => {
            if (!currentUser) return;
            
            try {
                if (userEquippedBadge[currentUser.uid] === badgeId) {
                    await db.collection('equippedBadges').doc(currentUser.uid).delete();
                    showToast('Badge dilepas!', 'info');
                } else {
                    await db.collection('equippedBadges').doc(currentUser.uid).set({
                        badgeId: badgeId,
                        updatedAt: new Date()
                    });
                    showToast('Badge dipasang!', 'success');
                }
                toggleBadgeUseModal();
            } catch (error) {
                console.error('Error equipping badge:', error);
            }
        };

        window.toggleBadgeUseModal = (badge) => {
            selectedBadge = badge;
            showBadgeUseModal = !showBadgeUseModal;
            renderMainContent();
        };

        // ==================== FUNGSI LEVEL ====================
        async function updateUserLevel(userId) {
            if (!userId || userId.startsWith('manual_')) return;
            
            const userAttendance = attendanceHistory.filter(a => a.userId === userId).length;
            const level = calculateLevel(userAttendance);
            
            try {
                await db.collection('levels').doc(userId).set({
                    level: level.level,
                    title: level.title,
                    icon: level.icon,
                    attendance: userAttendance,
                    updatedAt: new Date()
                }, { merge: true });
                
                await db.collection('members').doc(userId).update({
                    level: level.level,
                    levelTitle: level.title,
                    levelIcon: level.icon
                });
                
            } catch (error) {
                console.error('Error updating level:', error);
            }
        }

        async function checkLevelUp(userId) {
            const userAttendance = attendanceHistory.filter(a => a.userId === userId).length;
            const oldLevel = userLevels[userId]?.level || 0;
            const newLevel = calculateLevel(userAttendance);
            
            if (newLevel.level > oldLevel) {
                playSound('levelUp');
                
                const currentPoints = userPoints[userId] || 0;
                const bonusPoints = newLevel.level * 100;
                await db.collection('points').doc(userId).set({
                    points: currentPoints + bonusPoints,
                    updatedAt: new Date()
                }, { merge: true });
                
                showToast(`üéä LEVEL UP! Level ${newLevel.level} - ${newLevel.title} +${bonusPoints} points!`, 'success');
                
                anime({
                    targets: '.level-badge',
                    scale: [1, 1.5, 1],
                    duration: 1000,
                    easing: 'easeInOutQuad'
                });
            }
            
            return newLevel;
        }

        // ==================== FUNGSI SPECIAL ====================
        async function checkConsecutiveDays(userId) {
            const userAttendance = attendanceHistory
                .filter(a => a.userId === userId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (userAttendance.length === 0) return;
            
            let consecutive = 1;
            let lastDate = moment(userAttendance[0].date);
            
            for (let i = 1; i < userAttendance.length; i++) {
                const currentDate = moment(userAttendance[i].date);
                if (lastDate.diff(currentDate, 'days') === 1) {
                    consecutive++;
                    lastDate = currentDate;
                } else {
                    break;
                }
            }
            
            await db.collection('consecutiveDays').doc(userId).set({
                days: consecutive,
                updatedAt: new Date()
            }, { merge: true });
        }

        async function checkEarlyBird(userId) {
            const earlyCount = attendanceHistory.filter(a => 
                a.userId === userId && 
                parseInt(a.time.split(':')[0]) < 8
            ).length;
            
            await db.collection('earlyBird').doc(userId).set({
                count: earlyCount,
                updatedAt: new Date()
            }, { merge: true });
        }

        async function checkNightOwl(userId) {
            const nightCount = attendanceHistory.filter(a => 
                a.userId === userId && 
                parseInt(a.time.split(':')[0]) >= 22
            ).length;
            
            await db.collection('nightOwl').doc(userId).set({
                count: nightCount,
                updatedAt: new Date()
            }, { merge: true });
        }

        // ==================== FUNGSI MISSIONS ====================
        async function updateMissions(userId) {
            if (!userId || userId.startsWith('manual_')) return;
            
            const userAttendance = attendanceHistory.filter(a => a.userId === userId).length;
            const userProjects = projects.filter(p => p.createdBy === userId).length;
            const userChats = chats.filter(c => c.userId === userId).length;
            const userFeeds = feeds.filter(f => f.userId === userId).length;
            const consecutive = userConsecutiveDays[userId] || 0;
            const earlyBird = userEarlyBird[userId] || 0;
            const nightOwl = userNightOwl[userId] || 0;
            const points = userPoints[userId] || 0;
            const followers = userFollowers[userId]?.length || 0;
            const following = userFollowing[userId]?.length || 0;
            
            const completedMissions = [];
            
            missions.forEach(mission => {
                let requirement = 0;
                if (mission.type === 'attendance') requirement = userAttendance;
                else if (mission.type === 'project') requirement = userProjects;
                else if (mission.type === 'consecutive') requirement = consecutive;
                else if (mission.type === 'early') requirement = earlyBird;
                else if (mission.type === 'night') requirement = nightOwl;
                else if (mission.type === 'chat') requirement = userChats;
                else if (mission.type === 'feed') requirement = userFeeds;
                else if (mission.type === 'points') requirement = points;
                else if (mission.type === 'follow') requirement = following;
                else if (mission.type === 'follower') requirement = followers;
                else requirement = userAttendance;
                
                if (requirement >= mission.requirement) {
                    completedMissions.push(mission.id);
                }
            });
            
            try {
                await db.collection('missions').doc(userId).set({
                    completed: completedMissions,
                    claimed: userMissions[userId]?.claimed || [],
                    updatedAt: new Date()
                }, { merge: true });
                
            } catch (error) {
                console.error('Error updating missions:', error);
            }
        }

        window.claimMissionReward = async (missionId) => {
            if (!currentUser) {
                showToast('Silakan login dulu', 'error');
                return;
            }
            
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;
            
            const userCompleted = userMissions[currentUser.uid]?.completed || [];
            const userClaimed = userMissions[currentUser.uid]?.claimed || [];
            
            if (!userCompleted.includes(missionId)) {
                showToast('Misi belum selesai!', 'warning');
                return;
            }
            
            if (userClaimed.includes(missionId)) {
                showToast('Reward sudah diklaim!', 'warning');
                return;
            }
            
            try {
                let currentBadges = userBadges[currentUser.uid]?.badges || [];
                if (!currentBadges.includes(mission.reward)) {
                    currentBadges.push(mission.reward);
                    
                    await db.collection('badges').doc(currentUser.uid).set({
                        badges: currentBadges,
                        updatedAt: new Date()
                    }, { merge: true });
                    
                    playSound('badge');
                }
                
                const currentPoints = userPoints[currentUser.uid] || 0;
                await db.collection('points').doc(currentUser.uid).set({
                    points: currentPoints + mission.points,
                    updatedAt: new Date()
                }, { merge: true });
                
                userClaimed.push(missionId);
                await db.collection('missions').doc(currentUser.uid).set({
                    claimed: userClaimed
                }, { merge: true });
                
                showToast(`‚úÖ Berhasil mengklaim ${mission.name}! +${mission.points} points`, 'success');
                
                if (currentPage === 'badges') {
                    renderMainContent();
                }
                
            } catch (error) {
                console.error('Error claiming reward:', error);
                showToast('Gagal mengklaim: ' + error.message, 'error');
            }
        };

        // ==================== MYSTERY BOX ====================
        window.openMysteryBox = async () => {
            if (!currentUser) {
                showToast('Silakan login dulu', 'warning');
                return;
            }

            const cost = 50;
            const userPoint = userPoints[currentUser.uid] || 0;
            
            if (userPoint < cost) {
                showToast(`Points tidak cukup! Butuh ${cost} ‚≠ê`, 'error');
                return;
            }

            const box = document.getElementById('mystery-box');
            if (box) box.classList.add('shake');

            setTimeout(async () => {
                box?.classList.remove('shake');
                
                await db.collection('points').doc(currentUser.uid).set({
                    points: userPoint - cost,
                    updatedAt: new Date()
                }, { merge: true });
                
                playSound('mystery');
                
                const rand = Math.random();
                let eligibleItems;
                
                if (rand < 0.5) { // 50% common
                    eligibleItems = mysteryBoxItems.filter(i => i.rare === 'common');
                } else if (rand < 0.75) { // 25% uncommon
                    eligibleItems = mysteryBoxItems.filter(i => i.rare === 'uncommon');
                } else if (rand < 0.9) { // 15% rare
                    eligibleItems = mysteryBoxItems.filter(i => i.rare === 'rare');
                } else if (rand < 0.97) { // 7% epic
                    eligibleItems = mysteryBoxItems.filter(i => i.rare === 'epic');
                } else { // 3% legendary
                    eligibleItems = mysteryBoxItems.filter(i => i.rare === 'legendary');
                }
                
                const randomIndex = Math.floor(Math.random() * eligibleItems.length);
                const item = eligibleItems[randomIndex];
                
                let message = `üéÅ Kamu mendapatkan: ${item.name} ${item.icon}`;
                
                if (item.type === 'badge') {
                    let currentBadges = userBadges[currentUser.uid]?.badges || [];
                    if (!currentBadges.includes(item.id)) {
                        currentBadges.push(item.id);
                        await db.collection('badges').doc(currentUser.uid).set({
                            badges: currentBadges,
                            updatedAt: new Date()
                        }, { merge: true });
                        
                        await db.collection('points').doc(currentUser.uid).set({
                            points: (userPoints[currentUser.uid] || 0) + item.points,
                            updatedAt: new Date()
                        }, { merge: true });
                        
                        message += ` (+${item.points} points)`;
                    }
                } else if (item.type === 'points') {
                    await db.collection('points').doc(currentUser.uid).set({
                        points: (userPoints[currentUser.uid] || 0) + item.amount,
                        updatedAt: new Date()
                    }, { merge: true });
                    message += ` (+${item.amount} points)`;
                } else if (item.type === 'title') {
                    let currentTitles = userTitles[currentUser.uid] || [];
                    if (!currentTitles.includes(item.title)) {
                        currentTitles.push(item.title);
                        await db.collection('titles').doc(currentUser.uid).set({
                            titles: currentTitles,
                            updatedAt: new Date()
                        }, { merge: true });
                        message += ` (Title: ${item.title})`;
                    }
                }
                
                showToast(message, 'success');
                
                anime({
                    targets: '.mystery-box',
                    scale: [1, 1.5, 1],
                    rotate: [0, 360, 0],
                    duration: 1000,
                    easing: 'easeInOutQuad'
                });
                
            }, 500);
        };

        // ==================== CHAT ====================
        window.sendChat = async (message) => {
            if (!currentUser || !message.trim()) return;
            
            try {
                const chatData = {
                    userId: currentUser.uid,
                    userName: userData?.name || currentUser.displayName,
                    userPhoto: userData?.photo || currentUser.photoURL,
                    message: message,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('chats').add(chatData);
                
                playSound('click');
                
            } catch (error) {
                console.error('Error sending chat:', error);
            }
        };

        // ==================== STORIES ====================
        window.createStory = async (imageUrl) => {
            if (!currentUser || !imageUrl) return;
            
            try {
                const storyData = {
                    userId: currentUser.uid,
                    userName: userData?.name || currentUser.displayName,
                    userPhoto: userData?.photo || currentUser.photoURL,
                    image: imageUrl,
                    views: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('stories').add(storyData);
                showToast('Story berhasil dibuat!', 'success');
                
            } catch (error) {
                console.error('Error creating story:', error);
            }
        };

        window.viewStory = async (storyId) => {
            if (!currentUser) return;
            
            const storyRef = db.collection('stories').doc(storyId);
            const story = stories.find(s => s.id === storyId);
            
            if (!story) return;
            
            const views = story.views || [];
            if (!views.includes(currentUser.uid)) {
                await storyRef.update({
                    views: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            }
            
            selectedStory = story;
            showStoryModal = true;
            renderMainContent();
        };

        // ==================== FEEDS ====================
        window.createFeed = async (data) => {
            if (!currentUser) return;
            
            try {
                const feedData = {
                    userId: currentUser.uid,
                    userName: userData?.name || currentUser.displayName,
                    userPhoto: userData?.photo || currentUser.photoURL,
                    type: data.type || 'post',
                    content: data.content,
                    image: data.image || null,
                    likes: [],
                    comments: [],
                    shares: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('feeds').add(feedData);
                showToast('Postingan berhasil dibuat!', 'success');
                
            } catch (error) {
                console.error('Error creating feed:', error);
            }
        };

        window.likeFeed = async (feedId) => {
            if (!currentUser) return;
            
            const feedRef = db.collection('feeds').doc(feedId);
            const feed = feeds.find(f => f.id === feedId);
            
            if (!feed) return;
            
            const likes = feed.likes || [];
            const userLiked = likes.includes(currentUser.uid);
            
            try {
                if (userLiked) {
                    await feedRef.update({
                        likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                    });
                } else {
                    await feedRef.update({
                        likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                }
            } catch (error) {
                console.error('Error liking feed:', error);
            }
        };

        window.commentOnFeed = async (feedId, comment) => {
            if (!currentUser || !comment.trim()) return;
            
            const commentData = {
                userId: currentUser.uid,
                userName: userData?.name || currentUser.displayName,
                userPhoto: userData?.photo || currentUser.photoURL,
                comment: comment,
                createdAt: new Date()
            };
            
            try {
                await db.collection('feeds').doc(feedId).update({
                    comments: firebase.firestore.FieldValue.arrayUnion(commentData)
                });
                showToast('Komentar ditambahkan', 'success');
            } catch (error) {
                console.error('Error commenting:', error);
            }
        };

        // ==================== FOLLOW SYSTEM ====================
        window.followUser = async (userId) => {
            if (!currentUser || userId === currentUser.uid) return;
            
            const followId = `${currentUser.uid}_${userId}`;
            const followRef = db.collection('follows').doc(followId);
            const isFollowing = userFollowing[currentUser.uid]?.includes(userId);
            
            try {
                if (isFollowing) {
                    await followRef.delete();
                    showToast('Berhenti mengikuti', 'info');
                } else {
                    await followRef.set({
                        followerId: currentUser.uid,
                        followingId: userId,
                        followerName: userData?.name || currentUser.displayName,
                        followingName: members.find(m => m.id === userId)?.name,
                        createdAt: new Date()
                    });
                    showToast('Sekarang mengikuti', 'success');
                }
            } catch (error) {
                console.error('Error following:', error);
            }
        };

        // ==================== FUNGSI ABSENSI ====================
        window.submitAttendance = async function() {
            if (!currentUser) {
                showToast('Silakan login terlebih dahulu', 'error');
                return;
            }
            
            try {
                const select = document.getElementById('attendance-member-select');
                const manualName = document.getElementById('attendance-manual-name')?.value.trim();
                const manualClass = document.getElementById('attendance-manual-class')?.value.trim();
                
                let userId, name, className, photo;
                
                if (select && select.value) {
                    const selectedOption = select.options[select.selectedIndex];
                    userId = select.value;
                    name = selectedOption.getAttribute('data-name');
                    className = selectedOption.getAttribute('data-class') || '';
                    photo = selectedOption.getAttribute('data-photo') || `https://ui-avatars.com/api/?name=${name}&background=00d4ff&color=fff`;
                } 
                else if (manualName) {
                    name = manualName;
                    className = manualClass || 'Kelas tidak diisi';
                    userId = 'manual_' + Date.now();
                    photo = `https://ui-avatars.com/api/?name=${name}&background=00d4ff&color=fff`;
                } 
                else {
                    showToast('Pilih anggota atau isi nama manual', 'warning');
                    return;
                }
                
                const today = moment().format('YYYY-MM-DD');
                const now = moment().format('HH:mm');
                const hari = moment().format('dddd');
                
                if (userId && !userId.startsWith('manual_')) {
                    const existing = await db.collection('attendance')
                        .where('userId', '==', userId)
                        .where('date', '==', today)
                        .get();
                    
                    if (!existing.empty) {
                        showToast('Anggota ini sudah absen hari ini', 'error');
                        return;
                    }
                }
                
                const attendanceData = {
                    userId: userId,
                    name: name,
                    email: currentUser.email || '',
                    photo: photo,
                    class: className,
                    date: today,
                    day: hari,
                    time: now,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    submittedBy: currentUser.uid,
                    submittedByName: currentUser.displayName || currentUser.email
                };
                
                await db.runTransaction(async (transaction) => {
                    const attendanceRef = db.collection('attendance').doc();
                    transaction.set(attendanceRef, attendanceData);
                    
                    if (!userId.startsWith('manual_')) {
                        const memberRef = db.collection('members').doc(userId);
                        const memberDoc = await transaction.get(memberRef);
                        if (memberDoc.exists) {
                            const currentTotal = memberDoc.data().totalAttendance || 0;
                            transaction.update(memberRef, {
                                totalAttendance: currentTotal + 1,
                                lastAttendance: today
                            });
                        }
                    }
                });
                
                const currentPoints = userPoints[currentUser.uid] || 0;
                await db.collection('points').doc(currentUser.uid).set({
                    points: currentPoints + 10,
                    updatedAt: new Date()
                }, { merge: true });
                
                playSound('coin');
                
                if (select) select.value = '';
                if (document.getElementById('attendance-manual-name')) {
                    document.getElementById('attendance-manual-name').value = '';
                }
                if (document.getElementById('attendance-manual-class')) {
                    document.getElementById('attendance-manual-class').value = '';
                }
                
                showToast('Absensi berhasil untuk ' + name + ' +10 points', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal absen: ' + error.message, 'error');
            }
        };

        // ==================== FUNGSI DEVELOPER POWER ====================
        window.setUserLevel = async (userId, newLevel) => {
            if (userRole !== 'developer') {
                showToast('Fitur ini hanya untuk developer!', 'error');
                return;
            }
            
            try {
                const level = parseInt(newLevel);
                if (isNaN(level) || level < 1 || level > 100) {
                    showToast('Level harus 1-100!', 'error');
                    return;
                }
                
                const titles = ['Baru', 'Aktif', 'Super Aktif', 'Veteran', 'Legenda', 'Ultra', 'Mega', 'Hyper', 'Grand', 'Master', 'Dewa'];
                const icons = ['üÜï', 'üî•', '‚ö°', 'üéØ', 'üèÜ', 'üí´', '‚ú®', '‚≠ê', 'üåü', 'üëë', 'üëë'];
                
                let titleIndex = Math.min(Math.floor(level / 10), titles.length - 1);
                
                await db.collection('members').doc(userId).update({
                    level: level,
                    levelTitle: titles[titleIndex],
                    levelIcon: icons[titleIndex]
                });
                
                showToast('‚úÖ Level berhasil diubah!', 'success');
                
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        };

        window.makeAdmin = async (userId) => {
            if (userRole !== 'developer') {
                showToast('Fitur ini hanya untuk developer!', 'error');
                return;
            }
            
            try {
                await db.collection('members').doc(userId).update({
                    role: 'admin'
                });
                showToast('‚úÖ Anggota berhasil dijadikan admin!', 'success');
                
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        };

        window.removeAdmin = async (userId) => {
            if (userRole !== 'developer') {
                showToast('Fitur ini hanya untuk developer!', 'error');
                return;
            }
            
            try {
                await db.collection('members').doc(userId).update({
                    role: 'member'
                });
                showToast('‚úÖ Admin berhasil dihapus!', 'success');
                
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        };

        window.devAddBadge = async (userId, badgeId) => {
            if (userRole !== 'developer') {
                showToast('Fitur ini hanya untuk developer!', 'error');
                return;
            }
            
            try {
                let currentBadges = userBadges[userId]?.badges || [];
                
                if (!currentBadges.includes(badgeId)) {
                    const newBadges = [...currentBadges, badgeId];
                    
                    await db.collection('badges').doc(userId).set({
                        badges: newBadges,
                        updatedAt: new Date()
                    }, { merge: true });
                    
                    const badge = badges.find(b => b.id === badgeId);
                    showToast(`‚úÖ Berhasil menambah badge ${badge?.name || badgeId}!`, 'success');
                } else {
                    showToast('Badge sudah dimiliki user!', 'warning');
                }
            } catch (error) {
                console.error('Error adding badge:', error);
                showToast('Gagal: ' + error.message, 'error');
            }
        };

        window.devAddPoints = async (userId, points) => {
            if (userRole !== 'developer') return;
            
            const currentPoints = userPoints[userId] || 0;
            const newPoints = currentPoints + parseInt(points);
            
            await db.collection('points').doc(userId).set({
                points: newPoints,
                updatedAt: new Date()
            }, { merge: true });
            
            showToast(`‚úÖ Menambah ${points} points!`, 'success');
        };

        window.devCompleteMission = async (userId, missionId) => {
            if (userRole !== 'developer') return;
            
            const userCompleted = userMissions[userId]?.completed || [];
            if (!userCompleted.includes(missionId)) {
                userCompleted.push(missionId);
                await db.collection('missions').doc(userId).set({
                    completed: userCompleted,
                    claimed: userMissions[userId]?.claimed || [],
                    updatedAt: new Date()
                }, { merge: true });
                showToast('‚úÖ Misi diselesaikan!', 'success');
            }
        };

        window.devAddTitle = async (userId, title) => {
            if (userRole !== 'developer') return;
            
            let currentTitles = userTitles[userId] || [];
            if (!currentTitles.includes(title)) {
                currentTitles.push(title);
                await db.collection('titles').doc(userId).set({
                    titles: currentTitles,
                    updatedAt: new Date()
                }, { merge: true });
                showToast('‚úÖ Title ditambahkan!', 'success');
            }
        };

        window.devResetAll = async () => {
            if (userRole !== 'developer') return;
            
            const result = await Swal.fire({
                title: '‚ö†Ô∏è Reset Semua Data?',
                text: 'Data yang dihapus tidak dapat dikembalikan!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Reset!',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                const collections = ['members', 'attendance', 'projects', 'schedules', 'notifications', 'teachers', 'badges', 'levels', 'points', 'missions', 'equippedBadges', 'chats', 'consecutiveDays', 'earlyBird', 'nightOwl', 'stories', 'feeds', 'follows', 'titles'];
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                
                showToast('‚úÖ Semua data berhasil direset!', 'success');
                setTimeout(() => window.location.reload(), 2000);
            }
        };

        // ==================== FUNGSI LOGIN/LOGOUT ====================
        window.loginWithGoogle = async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                await handleUserLogin(result.user);
            } catch (error) {
                showToast('Login gagal: ' + error.message, 'error');
            }
        };

        window.loginWithEmail = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                if (email === DEV_EMAIL && password === DEV_PASSWORD) {
                    currentUser = { email: DEV_EMAIL, uid: 'dev_uid', displayName: 'Developer' };
                    userRole = 'developer';
                    userData = { 
                        name: 'Developer', 
                        role: 'developer', 
                        photo: 'https://ui-avatars.com/api/?name=Developer&background=ff00ff&color=fff',
                        level: 100,
                        levelTitle: 'Dewa',
                        levelIcon: 'üëë',
                        class: 'DEV'
                    };
                    
                    await db.collection('points').doc('dev_uid').set({
                        points: 999999,
                        updatedAt: new Date()
                    });
                    
                    showLoginModal = false;
                    renderMainContent();
                    showToast('üéÆ Login developer berhasil!', 'success');
                    return;
                }
                
                const result = await auth.signInWithEmailAndPassword(email, password);
                await handleUserLogin(result.user);
            } catch (error) {
                showToast('Login gagal: ' + error.message, 'error');
            }
        };

        async function handleUserLogin(user) {
            currentUser = user;
            
            if (user.email === DEV_EMAIL) {
                userRole = 'developer';
                userData = { 
                    name: 'Developer', 
                    role: 'developer', 
                    photo: user.photoURL || 'https://ui-avatars.com/api/?name=Developer&background=ff00ff&color=fff',
                    level: 100,
                    levelTitle: 'Dewa',
                    levelIcon: 'üëë',
                    class: 'DEV'
                };
            } else {
                const memberQuery = await db.collection('members').where('email', '==', user.email).get();
                if (!memberQuery.empty) {
                    userData = memberQuery.docs[0].data();
                    userRole = userData.role || 'member';
                } else {
                    userData = {
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        photo: user.photoURL || `https://ui-avatars.com/api/?name=${user.email.split('@')[0].replace(/\./g, '+')}&background=00d4ff&color=fff`,
                        role: 'member',
                        class: '',
                        level: 0,
                        levelTitle: 'Baru',
                        levelIcon: 'üÜï',
                        totalAttendance: 0,
                        joinDate: new Date()
                    };
                    await db.collection('members').add(userData);
                    userRole = 'member';
                }
            }
            
            showLoginModal = false;
            safeRender();
            showToast(`Selamat datang, ${userData?.name || user.displayName}!`, 'success');
        }

        window.register = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const className = document.getElementById('register-class').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            
            if (password !== confirm) {
                showToast('Password tidak cocok!', 'error');
                return;
            }
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                
                const newMember = {
                    name,
                    email,
                    class: className,
                    role: 'member',
                    photo: `https://ui-avatars.com/api/?name=${name.replace(/ /g, '+')}&background=00d4ff&color=fff`,
                    joinDate: new Date(),
                    totalAttendance: 0,
                    level: 0,
                    levelTitle: 'Baru',
                    levelIcon: 'üÜï',
                    bio: ''
                };
                
                await db.collection('members').add(newMember);
                await db.collection('points').doc(result.user.uid).set({
                    points: 100,
                    updatedAt: new Date()
                });
                
                currentUser = result.user;
                userData = newMember;
                userRole = 'member';
                
                showRegisterModal = false;
                renderMainContent();
                showToast('Pendaftaran berhasil! +100 points', 'success');
                
            } catch (error) {
                showToast('Pendaftaran gagal: ' + error.message, 'error');
            }
        };

        window.logout = () => {
            auth.signOut();
            currentUser = null;
            userData = null;
            userRole = 'member';
            renderMainContent();
            showToast('Berhasil logout');
        };

        // ==================== NOTIFIKASI ====================
        window.markAsRead = async (notificationId) => {
            if (!currentUser) return;
            
            try {
                const notificationRef = db.collection('notifications').doc(notificationId);
                const notification = await notificationRef.get();
                
                if (notification.exists) {
                    const readBy = notification.data().readBy || [];
                    if (!readBy.includes(currentUser.uid)) {
                        readBy.push(currentUser.uid);
                        await notificationRef.update({ readBy });
                    }
                }
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        };

        window.markAllAsRead = async () => {
            if (!currentUser) return;
            
            try {
                const batch = db.batch();
                
                notifications.forEach(n => {
                    if (!n.readBy || !n.readBy.includes(currentUser.uid)) {
                        const ref = db.collection('notifications').doc(n.id);
                        const readBy = n.readBy || [];
                        readBy.push(currentUser.uid);
                        batch.update(ref, { readBy });
                    }
                });
                
                await batch.commit();
                updateNotificationPanel();
                showToast('Semua notifikasi telah dibaca');
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        };

        // ==================== PROFILE ====================
        window.updateProfile = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('edit-name').value;
            const className = document.getElementById('edit-class').value;
            const bio = document.getElementById('edit-bio').value;
            const photoUrl = document.getElementById('profile-preview').src;
            
            try {
                if (currentUser && currentUser.updateProfile) {
                    await currentUser.updateProfile({ 
                        displayName: name,
                        photoURL: photoUrl 
                    });
                }
                
                const memberQuery = await db.collection('members').where('email', '==', currentUser.email).get();
                if (!memberQuery.empty) {
                    await memberQuery.docs[0].ref.update({
                        name,
                        class: className,
                        bio,
                        photo: photoUrl,
                        updatedAt: new Date()
                    });
                }
                
                userData = { ...userData, name, class: className, bio, photo: photoUrl };
                
                showEditProfileModal = false;
                selectedMember = null;
                renderMainContent();
                showToast('Profile berhasil diupdate!', 'success');
                
            } catch (error) {
                showToast('Gagal update: ' + error.message, 'error');
            }
        };

        window.viewMemberProfile = (memberId) => {
            const member = members.find(m => m.id === memberId);
            if (member) {
                selectedMember = member;
                showEditProfileModal = true;
                renderMainContent();
            }
        };

        // ==================== LEADERBOARD ====================
        function calculateLeaderboard() {
            const attendanceCount = {};
            attendanceHistory.forEach(a => {
                if (a.userId && !a.userId.startsWith('manual_')) {
                    attendanceCount[a.userId] = (attendanceCount[a.userId] || 0) + 1;
                }
            });
            
            leaderboardData = members.map(m => {
                const attendance = attendanceCount[m.id] || 0;
                const level = calculateLevel(attendance);
                return {
                    id: m.id,
                    name: m.name,
                    photo: m.photo,
                    class: m.class,
                    attendance: attendance,
                    projects: projects.filter(p => p.createdBy === m.id).length,
                    level: level,
                    points: userPoints[m.id] || 0,
                    badges: userBadges[m.id]?.badges || [],
                    followers: userFollowers[m.id]?.length || 0,
                    following: userFollowing[m.id]?.length || 0
                };
            }).sort((a, b) => b.points - a.points || b.attendance - a.attendance);
        }

        // ==================== NAVIGASI ====================
        window.navigateTo = (page) => {
            currentPage = page;
            renderMainContent();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const menu = document.getElementById('mobile-menu');
            const hamburger = document.getElementById('hamburger');
            if (menu && menu.classList.contains('show')) {
                menu.classList.remove('show');
                hamburger?.classList.remove('active');
            }
        };

        window.toggleMobileMenu = () => {
            const menu = document.getElementById('mobile-menu');
            const hamburger = document.getElementById('hamburger');
            if (menu && hamburger) {
                menu.classList.toggle('show');
                hamburger.classList.toggle('active');
            }
        };

        window.toggleNotificationPanel = () => {
            showNotificationPanel = !showNotificationPanel;
            updateNotificationPanel();
        };

        window.toggleLoginModal = () => {
            showLoginModal = !showLoginModal;
            showRegisterModal = false;
            showForgotModal = false;
            renderMainContent();
        };

        window.toggleRegisterModal = () => {
            showRegisterModal = !showRegisterModal;
            showLoginModal = false;
            renderMainContent();
        };

        window.toggleForgotModal = () => {
            showForgotModal = !showForgotModal;
            showLoginModal = false;
            renderMainContent();
        };

        window.toggleEditProfileModal = () => {
            showEditProfileModal = !showEditProfileModal;
            if (!showEditProfileModal) selectedMember = null;
            renderMainContent();
        };

        window.toggleAddProjectModal = () => {
            showAddProjectModal = !showAddProjectModal;
            renderMainContent();
        };

        window.toggleEditProjectModal = () => {
            showEditProjectModal = !showEditProjectModal;
            if (!showEditProjectModal) selectedProject = null;
            renderMainContent();
        };

        window.toggleAddScheduleModal = () => {
            showAddScheduleModal = !showAddScheduleModal;
            renderMainContent();
        };

        window.toggleEditScheduleModal = () => {
            showEditScheduleModal = !showEditScheduleModal;
            if (!showEditScheduleModal) selectedSchedule = null;
            renderMainContent();
        };

        window.toggleAddNotificationModal = () => {
            showAddNotificationModal = !showAddNotificationModal;
            renderMainContent();
        };

        window.toggleAddTeacherModal = () => {
            showAddTeacherModal = !showAddTeacherModal;
            renderMainContent();
        };

        window.toggleEditTeacherModal = () => {
            showEditTeacherModal = !showEditTeacherModal;
            if (!showEditTeacherModal) selectedTeacher = null;
            renderMainContent();
        };

        window.toggleAttendanceHistoryModal = () => {
            showAttendanceHistoryModal = !showAttendanceHistoryModal;
            renderMainContent();
        };

        window.toggleLeaderboardModal = () => {
            showLeaderboardModal = !showLeaderboardModal;
            renderMainContent();
        };

        window.toggleAddAdminModal = () => {
            showAddAdminModal = !showAddAdminModal;
            renderMainContent();
        };

        window.toggleRemoveAdminModal = () => {
            showRemoveAdminModal = !showRemoveAdminModal;
            renderMainContent();
        };

        window.toggleSetLevelModal = () => {
            showSetLevelModal = !showSetLevelModal;
            renderMainContent();
        };

        window.toggleDevPowerModal = () => {
            showDevPowerModal = !showDevPowerModal;
            renderMainContent();
        };

        window.toggleMissionsModal = () => {
            showMissionsModal = !showMissionsModal;
            renderMainContent();
        };

        window.toggleBadgeUseModal = () => {
            showBadgeUseModal = !showBadgeUseModal;
            if (!showBadgeUseModal) selectedBadge = null;
            renderMainContent();
        };

        window.toggleQRModal = () => {
            showQRModal = !showQRModal;
            if (showQRModal && currentUser) {
                setTimeout(() => {
                    generateQRCode(window.location.href + '?user=' + currentUser.uid);
                }, 100);
            }
            renderMainContent();
        };

        window.toggleChatModal = () => {
            showChatModal = !showChatModal;
            renderMainContent();
        };

        window.toggleMysteryBoxModal = () => {
            showMysteryBoxModal = !showMysteryBoxModal;
            renderMainContent();
        };

        window.toggleStoryModal = () => {
            showStoryModal = !showStoryModal;
            if (!showStoryModal) selectedStory = null;
            renderMainContent();
        };

        window.toggleFeedModal = () => {
            showFeedModal = !showFeedModal;
            renderMainContent();
        };

        window.showEditProfile = () => {
            showEditProfileModal = true;
            selectedMember = null;
            renderMainContent();
        };

        // ==================== NOTIFIKASI PANEL ====================
        function updateNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            if (!panel) return;
            
            if (showNotificationPanel) {
                panel.classList.add('show');
                panel.innerHTML = `
                    <div class="p-3 border-b border-white/10 flex justify-between items-center">
                        <h4 class="font-bold">Notifikasi</h4>
                        ${unreadCount > 0 ? `
                            <button onclick="markAllAsRead()" class="text-xs text-blue-400">Tandai semua dibaca</button>
                        ` : ''}
                    </div>
                    <div class="max-h-80 overflow-y-auto">
                        ${notifications.length > 0 ? notifications.map(n => `
                            <div class="notification-item ${currentUser && (!n.readBy || !n.readBy.includes(currentUser.uid)) ? 'unread' : ''}" onclick="markAsRead('${n.id}')">
                                <p class="font-semibold text-sm">${n.title}</p>
                                <p class="text-xs text-gray-400 mt-1">${n.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${n.createdAt ? moment(n.createdAt.toDate()).fromNow() : 'Baru saja'}</p>
                            </div>
                        `).join('') : `
                            <p class="text-center text-gray-400 py-4 text-sm">Tidak ada notifikasi</p>
                        `}
                    </div>
                `;
            } else {
                panel.classList.remove('show');
            }
        }

        // ==================== RENDER UTAMA ====================
        function renderMainContent() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <nav class="glass-effect fixed w-full top-0 z-40 px-4 sm:px-6 py-3" data-aos="fade-down">
                    <div class="max-w-7xl mx-auto flex justify-between items-center">
                        <div class="flex items-center space-x-2 sm:space-x-3">
                            <span class="text-3xl sm:text-4xl floating">${ekstraData.logo}</span>
                            <div class="hidden sm:block">
                                <h1 class="text-lg sm:text-xl font-bold roboto-font neon-text">${ekstraData.name}</h1>
                                <p class="text-xs text-gray-400">${ekstraData.school}</p>
                            </div>
                        </div>
                        
                        <div class="desktop-menu items-center space-x-6">
                            <button onclick="navigateTo('home')" class="hover:text-blue-400 transition ${currentPage === 'home' ? 'text-blue-400' : ''}">Home</button>
                            <button onclick="navigateTo('about')" class="hover:text-blue-400 transition ${currentPage === 'about' ? 'text-blue-400' : ''}">Tentang</button>
                            <button onclick="navigateTo('teachers')" class="hover:text-blue-400 transition ${currentPage === 'teachers' ? 'text-blue-400' : ''}">Pembina</button>
                            <button onclick="navigateTo('members')" class="hover:text-blue-400 transition ${currentPage === 'members' ? 'text-blue-400' : ''}">Anggota</button>
                            <button onclick="navigateTo('projects')" class="hover:text-blue-400 transition ${currentPage === 'projects' ? 'text-blue-400' : ''}">Proyek</button>
                            <button onclick="navigateTo('attendance')" class="hover:text-blue-400 transition ${currentPage === 'attendance' ? 'text-blue-400' : ''}">Absensi</button>
                            <button onclick="navigateTo('schedule')" class="hover:text-blue-400 transition ${currentPage === 'schedule' ? 'text-blue-400' : ''}">Jadwal</button>
                            <button onclick="navigateTo('badges')" class="hover:text-blue-400 transition ${currentPage === 'badges' ? 'text-blue-400' : ''}">Badges</button>
                            <button onclick="navigateTo('leaderboard')" class="hover:text-blue-400 transition ${currentPage === 'leaderboard' ? 'text-blue-400' : ''}">Leaderboard</button>
                            <button onclick="navigateTo('missions')" class="hover:text-blue-400 transition ${currentPage === 'missions' ? 'text-blue-400' : ''}">Misi</button>
                            <button onclick="toggleChatModal()" class="hover:text-blue-400 transition">Chat</button>
                            <button onclick="toggleMysteryBoxModal()" class="hover:text-yellow-400 transition">üéÅ Box</button>
                            <button onclick="toggleFeedModal()" class="hover:text-green-400 transition">üìù Feed</button>
                        </div>
                        
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <div class="relative">
                                <button onclick="toggleNotificationPanel()" class="relative p-2 hover:bg-white/10 rounded-full">
                                    <i class="fas fa-bell text-lg sm:text-xl"></i>
                                    ${unreadCount > 0 ? `
                                        <span class="notification-badge">${unreadCount > 9 ? '9+' : unreadCount}</span>
                                    ` : ''}
                                </button>
                            </div>
                            
                            ${currentUser ? `
                                <div class="relative group">
                                    <div class="flex items-center space-x-2 cursor-pointer">
                                        <img src="${userData?.photo || currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + (userData?.name || 'User')}" 
                                             class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-blue-400"
                                             onerror="this.src='https://ui-avatars.com/api/?name=${userData?.name || 'User'}&background=00d4ff&color=fff'">
                                        ${userRole === 'developer' ? '<span class="developer-badge">DEV</span>' : ''}
                                        ${userRole === 'admin' ? '<span class="admin-badge">ADMIN</span>' : ''}
                                    </div>
                                    <div class="absolute right-0 mt-2 w-48 glass-card hidden group-hover:block p-2 z-50">
                                        <div class="p-2 border-b border-white/10">
                                            <p class="font-semibold text-sm">${userData?.name || currentUser.displayName}</p>
                                            <p class="text-xs text-gray-400">${userData?.class || 'Anggota'}</p>
                                            <p class="text-xs text-blue-400 mt-1">
                                                ${userData?.levelIcon || 'üÜï'} Level ${userData?.level || 0} ‚Ä¢ ${userData?.levelTitle || 'Baru'}
                                            </p>
                                            <p class="text-xs text-yellow-400 mt-1">
                                                ‚≠ê ${userPoints[currentUser.uid] || 0} Points
                                            </p>
                                            <p class="text-xs text-pink-400 mt-1">
                                                üë• Followers: ${userFollowers[currentUser.uid]?.length || 0}
                                            </p>
                                        </div>
                                        <button onclick="showEditProfile()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm">
                                            <i class="fas fa-user-edit mr-2"></i>Edit Profile
                                        </button>
                                        
                                        <button onclick="toggleQRModal()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm">
                                            <i class="fas fa-qrcode mr-2"></i>QR Code Saya
                                        </button>
                                        
                                        ${(userRole === 'developer' || userRole === 'admin') ? `
                                            <div class="border-t border-white/10 my-1"></div>
                                            <p class="text-xs text-gray-400 px-2 py-1">MANAJEMEN</p>
                                            <button onclick="showAddProjectModal = true; renderMainContent()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-green-400">
                                                <i class="fas fa-plus-circle mr-2"></i>Tambah Proyek
                                            </button>
                                            <button onclick="showAddScheduleModal = true; renderMainContent()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-blue-400">
                                                <i class="fas fa-calendar-plus mr-2"></i>Tambah Jadwal
                                            </button>
                                            <button onclick="showAddNotificationModal = true; renderMainContent()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-yellow-400">
                                                <i class="fas fa-bell mr-2"></i>Buat Notifikasi
                                            </button>
                                            <button onclick="showAddTeacherModal = true; renderMainContent()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-purple-400">
                                                <i class="fas fa-chalkboard-teacher mr-2"></i>Tambah Pembina
                                            </button>
                                        ` : ''}
                                        
                                        ${userRole === 'developer' ? `
                                            <div class="border-t border-white/10 my-1"></div>
                                            <p class="text-xs text-gray-400 px-2 py-1">DEVELOPER POWER</p>
                                            <button onclick="toggleAddAdminModal()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-yellow-400">
                                                <i class="fas fa-crown mr-2"></i>Jadikan Admin
                                            </button>
                                            <button onclick="toggleRemoveAdminModal()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-red-400">
                                                <i class="fas fa-user-minus mr-2"></i>Hapus Admin
                                            </button>
                                            <button onclick="toggleSetLevelModal()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-blue-400">
                                                <i class="fas fa-arrow-up mr-2"></i>Atur Level
                                            </button>
                                            <button onclick="toggleDevPowerModal()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-pink-400">
                                                <i class="fas fa-bolt mr-2"></i>Dev Power
                                            </button>
                                        ` : ''}
                                        
                                        <div class="border-t border-white/10 my-1"></div>
                                        <button onclick="logout()" class="block w-full text-left p-2 hover:bg-white/10 rounded text-sm text-red-400">
                                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <button onclick="toggleLoginModal()" class="gradient-bg px-3 sm:px-4 py-2 rounded-lg text-white text-sm sm:text-base font-semibold hover:scale-105 transition">
                                    Login
                                </button>
                            `}
                            
                            <button onclick="toggleMobileMenu()" class="mobile-menu-button flex items-center justify-center p-2 hover:bg-white/10 rounded-lg">
                                <div class="hamburger" id="hamburger">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </button>
                        </div>
                    </div>
                </nav>

                <div id="mobile-menu" class="mobile-menu">
                    <div class="p-4 border-b border-white/10">
                        ${currentUser ? `
                            <div class="flex items-center space-x-3">
                                <img src="${userData?.photo || currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + (userData?.name || 'User')}" 
                                     class="w-12 h-12 rounded-full border-2 border-blue-400"
                                     onerror="this.src='https://ui-avatars.com/api/?name=${userData?.name || 'User'}&background=00d4ff&color=fff'">
                                <div>
                                    <p class="font-semibold">${userData?.name || currentUser.displayName}</p>
                                    <p class="text-xs text-gray-400">${userData?.class || 'Anggota'}</p>
                                    <p class="text-xs text-blue-400">${userData?.levelIcon || 'üÜï'} Level ${userData?.level || 0}</p>
                                </div>
                            </div>
                        ` : `
                            <button onclick="toggleLoginModal(); toggleMobileMenu()" class="w-full gradient-bg py-2 rounded-lg font-semibold">
                                Login
                            </button>
                        `}
                    </div>
                    
                    <div class="py-2">
                        <button onclick="navigateTo('home'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-home mr-3"></i>Home
                        </button>
                        <button onclick="navigateTo('about'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-info-circle mr-3"></i>Tentang
                        </button>
                        <button onclick="navigateTo('teachers'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-chalkboard-teacher mr-3"></i>Pembina
                        </button>
                        <button onclick="navigateTo('members'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-users mr-3"></i>Anggota
                        </button>
                        <button onclick="navigateTo('projects'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-robot mr-3"></i>Proyek
                        </button>
                        <button onclick="navigateTo('attendance'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-calendar-check mr-3"></i>Absensi
                        </button>
                        <button onclick="navigateTo('schedule'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-calendar-alt mr-3"></i>Jadwal
                        </button>
                        <button onclick="navigateTo('badges'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-medal mr-3"></i>Badges
                        </button>
                        <button onclick="navigateTo('leaderboard'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-trophy mr-3"></i>Leaderboard
                        </button>
                        <button onclick="navigateTo('missions'); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-flag mr-3"></i>Misi
                        </button>
                        <button onclick="toggleChatModal(); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-comments mr-3"></i>Chat
                        </button>
                        <button onclick="toggleMysteryBoxModal(); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-gift mr-3"></i>Mystery Box
                        </button>
                        <button onclick="toggleFeedModal(); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-newspaper mr-3"></i>Feed
                        </button>
                        <button onclick="toggleQRModal(); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                            <i class="fas fa-qrcode mr-3"></i>QR Code
                        </button>
                    </div>
                    
                    ${currentUser ? `
                        <div class="border-t border-white/10 py-2">
                            <button onclick="showEditProfile(); toggleMobileMenu()" class="mobile-menu-item w-full text-left">
                                <i class="fas fa-user-edit mr-3"></i>Edit Profile
                            </button>
                            <button onclick="logout(); toggleMobileMenu()" class="mobile-menu-item w-full text-left text-red-400">
                                <i class="fas fa-sign-out-alt mr-3"></i>Logout
                            </button>
                        </div>
                    ` : ''}
                </div>

                <main class="pt-16 sm:pt-20 min-h-screen">
                    ${renderPage()}
                </main>

                <footer class="glass-effect py-8 px-4 mt-10">
                    <div class="max-w-6xl mx-auto text-center">
                        <p class="text-sm text-gray-400">¬© 2026 Robotik & Pemrograman - SMK TI Bali Global Karangasem</p>
                        <p class="text-xs text-gray-500 mt-2">
                            Points: ‚≠ê ${userPoints[currentUser?.uid] || 0} | 
                            Badges: üèÖ ${userBadges[currentUser?.uid]?.badges?.length || 0} | 
                            Level: ${userData?.level || 0}
                        </p>
                    </div>
                </footer>

                ${showLoginModal ? renderLoginModal() : ''}
                ${showRegisterModal ? renderRegisterModal() : ''}
                ${showForgotModal ? renderForgotModal() : ''}
                ${showEditProfileModal ? renderEditProfileModal() : ''}
                ${showAddProjectModal ? renderAddProjectModal() : ''}
                ${showAddScheduleModal ? renderAddScheduleModal() : ''}
                ${showAddNotificationModal ? renderAddNotificationModal() : ''}
                ${showAddTeacherModal ? renderAddTeacherModal() : ''}
                ${showAddAdminModal ? renderAddAdminModal() : ''}
                ${showRemoveAdminModal ? renderRemoveAdminModal() : ''}
                ${showSetLevelModal ? renderSetLevelModal() : ''}
                ${showDevPowerModal ? renderDevPowerModal() : ''}
                ${showMissionsModal ? renderMissionsModal() : ''}
                ${showBadgeUseModal ? renderBadgeUseModal() : ''}
                ${showQRModal ? renderQRModal() : ''}
                ${showChatModal ? renderChatModal() : ''}
                ${showMysteryBoxModal ? renderMysteryBoxModal() : ''}
                ${showStoryModal ? renderStoryModal() : ''}
                ${showFeedModal ? renderFeedModal() : ''}
                ${showEditProjectModal ? renderEditProjectModal() : ''}
                ${showEditScheduleModal ? renderEditScheduleModal() : ''}
                ${showEditTeacherModal ? renderEditTeacherModal() : ''}
                ${showAttendanceHistoryModal ? renderAttendanceHistoryModal() : ''}
                ${showLeaderboardModal ? renderLeaderboardModal() : ''}
            `;

            updateNotificationPanel();
            
            if (currentPage === 'attendance' && (userRole === 'developer' || userRole === 'admin')) {
                setTimeout(() => {
                    renderAttendanceChart();
                }, 500);
            }
        }

        function renderPage() {
            switch(currentPage) {
                case 'about': return renderAboutPage();
                case 'teachers': return renderTeachersPage();
                case 'members': return renderMembersPage();
                case 'projects': return renderProjectsPage();
                case 'attendance': return renderAttendancePage();
                case 'schedule': return renderSchedulePage();
                case 'badges': return renderBadgesPage();
                case 'leaderboard': return renderLeaderboardPage();
                case 'missions': return renderMissionsPage();
                default: return renderHomePage();
            }
        }

        function renderHomePage() {
            const myAttendance = currentUser ? attendanceHistory.filter(a => a.userId === currentUser.uid).length : 0;
            const myLevel = currentUser ? calculateLevel(myAttendance) : { level: 0, title: 'Baru', icon: 'üÜï' };
            
            return `
                <section class="min-h-[80vh] flex items-center justify-center px-4 py-10">
                    <div class="text-center max-w-4xl">
                        <div class="text-6xl sm:text-8xl mb-4 floating glowing" data-aos="zoom-in">${ekstraData.logo}</div>
                        <h1 class="text-4xl sm:text-6xl md:text-8xl font-bold roboto-font mb-4 neon-text" data-aos="fade-up">
                            ${ekstraData.name}
                        </h1>
                        <p class="text-base sm:text-lg md:text-xl text-gray-300 mb-8 max-w-2xl mx-auto px-4" data-aos="fade-up" data-aos-delay="100">
                            ${ekstraData.description}
                        </p>
                        
                        <!-- Stories -->
                        ${stories.length > 0 ? `
                            <div class="flex gap-4 overflow-x-auto py-4 mb-8" data-aos="fade-up">
                                ${stories.filter(s => moment(s.createdAt.toDate()).isAfter(moment().subtract(24, 'hours'))).map(story => `
                                    <div class="story-circle ${story.userId === currentUser?.uid ? 'has-story' : ''}" onclick="viewStory('${story.id}')">
                                        <img src="${story.userPhoto}" alt="${story.userName}">
                                    </div>
                                `).join('')}
                                ${currentUser ? `
                                    <div class="story-circle" onclick="uploadStoryPhoto()">
                                        <div class="w-full h-full rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-2xl">
                                            +
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : currentUser ? `
                            <button onclick="uploadStoryPhoto()" class="mb-8 gradient-bg px-6 py-3 rounded-lg font-semibold">
                                Buat Story Pertama
                            </button>
                        ` : ''}
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-6 max-w-4xl mx-auto px-4 mb-8" data-aos="fade-up" data-aos-delay="200">
                            <div class="glass-card p-3 sm:p-4 hover-scale">
                                <div class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-400">${members.length}+</div>
                                <div class="text-xs sm:text-sm">Anggota</div>
                            </div>
                            <div class="glass-card p-3 sm:p-4 hover-scale">
                                <div class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-400">${projects.length}</div>
                                <div class="text-xs sm:text-sm">Proyek</div>
                            </div>
                            <div class="glass-card p-3 sm:p-4 hover-scale">
                                <div class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-400">${badges.length}</div>
                                <div class="text-xs sm:text-sm">Total Badge</div>
                            </div>
                            <div class="glass-card p-3 sm:p-4 hover-scale">
                                <div class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-400">${chats.length}</div>
                                <div class="text-xs sm:text-sm">Pesan</div>
                            </div>
                        </div>
                        
                        ${currentUser ? `
                            <div class="glass-card p-6 mb-8" data-aos="fade-up">
                                <h3 class="text-xl font-bold mb-4">Statistik Anda</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-gray-400">Level</p>
                                        <p class="text-2xl font-bold text-blue-400">${myLevel.icon} ${myLevel.level} ‚Ä¢ ${myLevel.title}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Kehadiran</p>
                                        <p class="text-2xl font-bold text-green-400">${myAttendance}x</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Points</p>
                                        <p class="text-2xl font-bold text-yellow-400">‚≠ê ${userPoints[currentUser.uid] || 0}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Badges</p>
                                        <p class="text-2xl font-bold text-purple-400">${userBadges[currentUser.uid]?.badges?.length || 0}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Followers</p>
                                        <p class="text-2xl font-bold text-pink-400">${userFollowers[currentUser.uid]?.length || 0}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Following</p>
                                        <p class="text-2xl font-bold text-orange-400">${userFollowing[currentUser.uid]?.length || 0}</p>
                                    </div>
                                </div>
                                ${userEquippedBadge[currentUser.uid] ? `
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-400">Badge Terpasang:</p>
                                        <div class="inline-block p-2 bg-white/5 rounded-lg mt-1 cursor-pointer" onclick="toggleBadgeUseModal('${userEquippedBadge[currentUser.uid]}')">
                                            ${(() => {
                                                const badge = badges.find(b => b.id === userEquippedBadge[currentUser.uid]);
                                                return badge ? `<span class="text-2xl">${badge.icon}</span> <span class="text-sm">${badge.name}</span>` : '';
                                            })()}
                                        </div>
                                    </div>
                                ` : ''}
                                ${userTitles[currentUser.uid]?.length > 0 ? `
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-400">Title:</p>
                                        <div class="flex flex-wrap gap-2 mt-1">
                                            ${userTitles[currentUser.uid].map(title => `
                                                <span class="text-xs bg-gradient-to-r from-purple-600 to-pink-600 px-2 py-1 rounded-full">${title}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="flex flex-wrap gap-4 justify-center" data-aos="fade-up">
                            <button onclick="navigateTo('attendance')" class="gradient-bg px-6 py-3 rounded-lg font-semibold hover:scale-105 transition">
                                <i class="fas fa-calendar-check mr-2"></i>Absen Sekarang
                            </button>
                            <button onclick="toggleMysteryBoxModal()" class="bg-gradient-to-r from-yellow-500 to-orange-500 px-6 py-3 rounded-lg font-semibold hover:scale-105 transition">
                                <i class="fas fa-gift mr-2"></i>Buka Mystery Box (50‚≠ê)
                            </button>
                            <button onclick="toggleChatModal()" class="bg-gradient-to-r from-green-500 to-teal-500 px-6 py-3 rounded-lg font-semibold hover:scale-105 transition">
                                <i class="fas fa-comments mr-2"></i>Chat Room
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Recent Feeds -->
                <section class="py-10 px-4">
                    <div class="max-w-3xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6 roboto-font neon-text" data-aos="fade-up">üì± Feed Terbaru</h2>
                        
                        <div class="space-y-4">
                            ${feeds.slice(0, 5).map(feed => `
                                <div class="glass-card p-4 hover-scale" data-aos="fade-up">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <img src="${feed.userPhoto}" class="w-10 h-10 rounded-full">
                                        <div>
                                            <p class="font-semibold">${feed.userName}</p>
                                            <p class="text-xs text-gray-400">${feed.createdAt ? moment(feed.createdAt.toDate()).fromNow() : 'Baru saja'}</p>
                                        </div>
                                    </div>
                                    
                                    <p class="mb-3">${feed.content}</p>
                                    
                                    ${feed.image ? `<img src="${feed.image}" class="post-image rounded-lg mb-3">` : ''}
                                    
                                    <div class="flex gap-4 text-gray-400">
                                        <button class="hover:text-blue-400 transition" onclick="likeFeed('${feed.id}')">
                                            <i class="fas fa-heart ${feed.likes?.includes(currentUser?.uid) ? 'text-red-500' : ''}"></i> ${feed.likes?.length || 0}
                                        </button>
                                        <button class="hover:text-blue-400 transition" onclick="commentOnFeed('${feed.id}', prompt('Tulis komentar:'))">
                                            <i class="fas fa-comment"></i> ${feed.comments?.length || 0}
                                        </button>
                                        <button class="hover:text-blue-400 transition">
                                            <i class="fas fa-share"></i> ${feed.shares || 0}
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${feeds.length === 0 ? `
                                <p class="text-gray-400 text-center py-8">Belum ada postingan. Jadilah yang pertama!</p>
                            ` : ''}
                        </div>
                        
                        <button onclick="toggleFeedModal()" class="w-full mt-4 gradient-bg py-3 rounded-lg font-semibold">
                            Buat Postingan Baru
                        </button>
                    </div>
                </section>

                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 sm:mb-12 roboto-font" data-aos="fade-up">
                            <span class="neon-text">Teknologi yang Dipelajari</span>
                        </h2>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3 sm:gap-4">
                            ${technologies.map((tech, index) => `
                                <div class="glass-card p-3 sm:p-4 text-center hover-scale" data-aos="fade-up" data-aos-delay="${index * 30}">
                                    <i class="${tech.icon} text-2xl sm:text-3xl mb-1 sm:mb-2" style="color: ${tech.color}"></i>
                                    <p class="text-xs sm:text-sm font-semibold">${tech.name}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </section>
            `;
        }

        function renderAboutPage() {
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 sm:mb-12 roboto-font" data-aos="fade-up">
                            <span class="neon-text">Tentang Ekskul</span>
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-6 sm:gap-8">
                            <div data-aos="fade-right">
                                <div class="glass-card p-5 sm:p-6">
                                    <h3 class="text-xl sm:text-2xl font-bold mb-3">Visi</h3>
                                    <p class="text-sm sm:text-base text-gray-300">${ekstraData.vision}</p>
                                </div>
                                
                                <div class="glass-card p-5 sm:p-6 mt-4 sm:mt-6">
                                    <h3 class="text-xl sm:text-2xl font-bold mb-3">Misi</h3>
                                    <ul class="space-y-2">
                                        ${ekstraData.mission.map(m => `
                                            <li class="flex items-start space-x-2 text-sm sm:text-base">
                                                <i class="fas fa-check-circle text-blue-400 mt-1 text-sm"></i>
                                                <span>${m}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                            
                            <div data-aos="fade-left">
                                <div class="glass-card p-5 sm:p-6">
                                    <h3 class="text-xl sm:text-2xl font-bold mb-4">Jadwal Latihan</h3>
                                    <div class="space-y-3">
                                        ${schedules.length > 0 ? schedules.map(s => `
                                            <div class="hover-scale">
                                                <div class="flex justify-between items-center p-2 sm:p-3 bg-white/5 rounded-lg text-sm sm:text-base">
                                                    <span class="font-medium">${s.day}</span>
                                                    <span class="text-blue-400">${s.time}</span>
                                                </div>
                                                <div class="text-xs text-gray-400 mt-1 px-2">${s.activity} - ${s.instructor}</div>
                                            </div>
                                        `).join('') : `
                                            <p class="text-gray-400 text-center py-4">Belum ada jadwal</p>
                                        `}
                                    </div>
                                    
                                    <h3 class="text-xl sm:text-2xl font-bold mt-6 mb-3">Tempat</h3>
                                    <p class="text-sm sm:text-base text-gray-300">Lab Komputer 1<br>SMK TI Bali Global Karangasem</p>
                                    
                                    <h3 class="text-xl sm:text-2xl font-bold mt-6 mb-3">Total Badge</h3>
                                    <p class="text-4xl font-bold text-blue-400">${badges.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderBadgesPage() {
            const myAttendance = currentUser ? attendanceHistory.filter(a => a.userId === currentUser.uid).length : 0;
            const myProjects = currentUser ? projects.filter(p => p.createdBy === currentUser.uid).length : 0;
            const myChats = currentUser ? chats.filter(c => c.userId === currentUser.uid).length : 0;
            const myBadges = currentUser ? (userBadges[currentUser.uid]?.badges || []) : [];
            const myLevel = currentUser ? calculateLevel(myAttendance) : { level: 0, title: 'Baru', icon: 'üÜï' };
            const equippedBadge = userEquippedBadge[currentUser?.uid];
            const myTitles = userTitles[currentUser?.uid] || [];
            
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 roboto-font" data-aos="fade-up">
                            <span class="neon-text">üèÖ Badge & Level</span>
                        </h2>
                        
                        ${currentUser ? `
                            <div class="glass-card p-6 mb-8 text-center level-badge" data-aos="fade-up">
                                <h3 class="text-2xl font-bold mb-2">${myLevel.icon} Level ${myLevel.level}</h3>
                                <p class="text-xl text-blue-400 mb-4">${myLevel.title}</p>
                                
                                <div class="flex justify-center space-x-2 mb-4 flex-wrap">
                                    <span class="level-badge text-lg px-4 py-2">
                                        <i class="fas fa-calendar-check mr-2"></i>${myAttendance} Kehadiran
                                    </span>
                                    <span class="level-badge text-lg px-4 py-2" style="background: linear-gradient(45deg, #ff00ff, #00ffff);">
                                        <i class="fas fa-code-branch mr-2"></i>${myProjects} Proyek
                                    </span>
                                    <span class="level-badge text-lg px-4 py-2" style="background: linear-gradient(45deg, #ffd700, #ffa500);">
                                        <i class="fas fa-star mr-2"></i>${userPoints[currentUser.uid] || 0} Points
                                    </span>
                                    <span class="level-badge text-lg px-4 py-2" style="background: linear-gradient(45deg, #FF69B4, #FF1493);">
                                        <i class="fas fa-comments mr-2"></i>${myChats} Chat
                                    </span>
                                </div>
                                
                                <div class="w-full bg-white/10 rounded-full h-4 mb-2">
                                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full transition-all duration-500" 
                                         style="width: ${Math.min(100, (myAttendance % 10) * 10)}%"></div>
                                </div>
                                <p class="text-sm text-gray-400">
                                    ${myAttendance % 10}/10 kehadiran menuju Level ${myLevel.level + 1}
                                </p>
                                
                                ${myTitles.length > 0 ? `
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-400">Title yang dimiliki:</p>
                                        <div class="flex flex-wrap gap-2 justify-center mt-2">
                                            ${myTitles.map(title => `
                                                <span class="text-xs bg-gradient-to-r from-purple-600 to-pink-600 px-3 py-1 rounded-full">${title}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${equippedBadge ? `
                                <div class="glass-card p-4 mb-6 text-center" data-aos="fade-up">
                                    <h3 class="text-lg font-bold mb-2">Badge Terpasang</h3>
                                    <div class="inline-block p-3 bg-gradient-to-r from-yellow-600 to-orange-600 rounded-lg cursor-pointer badge-equipped" onclick="toggleBadgeUseModal('${equippedBadge}')">
                                        ${(() => {
                                            const badge = badges.find(b => b.id === equippedBadge);
                                            return badge ? `
                                                <span class="text-4xl">${badge.icon}</span>
                                                <p class="font-bold">${badge.name}</p>
                                                <p class="text-xs">${badge.desc}</p>
                                                <p class="text-xs mt-1">Klik untuk melepas</p>
                                            ` : '';
                                        })()}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <h3 class="text-2xl font-bold mb-4" data-aos="fade-up">
                                <i class="fas fa-medal text-yellow-400 mr-2"></i>Badge yang Dimiliki
                                <span class="text-sm text-gray-400 ml-2">${myBadges.length} badge</span>
                            </h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-8" data-aos="fade-up">
                                ${badges.filter(b => myBadges.includes(b.id)).map(badge => `
                                    <div class="glass-card p-4 text-center hover-scale group badge-item ${badge.id === equippedBadge ? 'badge-equipped' : ''}" 
                                         onclick="toggleBadgeUseModal('${badge.id}')"
                                         style="border: 2px solid ${badge.color}">
                                        <div class="text-6xl mb-2 transform group-hover:scale-110 transition-all duration-300" style="filter: drop-shadow(0 0 10px ${badge.color});">${badge.icon}</div>
                                        <h4 class="font-bold text-sm">${badge.name}</h4>
                                        <p class="text-xs text-gray-400 mt-1">${badge.desc}</p>
                                        <p class="text-xs text-yellow-400 mt-1">+${badge.points} points</p>
                                        <div class="mt-2 text-xs bg-gradient-to-r from-yellow-600 to-orange-600 px-2 py-1 rounded-full inline-block">
                                            DIPEROLEH
                                        </div>
                                    </div>
                                `).join('')}
                                ${myBadges.length === 0 ? `
                                    <div class="col-span-4 text-center py-8">
                                        <p class="text-gray-400 mb-4">Belum memiliki badge. Selesaikan misi untuk mendapat badge!</p>
                                        <button onclick="navigateTo('missions')" class="gradient-bg px-6 py-3 rounded-lg font-semibold">
                                            Lihat Misi
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <h3 class="text-2xl font-bold mb-4" data-aos="fade-up">
                                <i class="fas fa-lock text-gray-400 mr-2"></i>Badge yang Tersedia
                            </h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" data-aos="fade-up">
                                ${badges.filter(b => !myBadges.includes(b.id)).map(badge => {
                                    let progress = 0;
                                    let current = 0;
                                    if (badge.id.includes('level_')) {
                                        current = myAttendance;
                                        progress = Math.min(100, (myAttendance / badge.target) * 100);
                                    } else if (badge.id === 'project_master' || badge.id === 'project_creator') {
                                        current = myProjects;
                                        progress = Math.min(100, (myProjects / badge.target) * 100);
                                    } else if (badge.id === 'master_chatter' || badge.id === 'veteran_chatter' || badge.id === 'legend_chatter') {
                                        current = myChats;
                                        progress = Math.min(100, (myChats / badge.target) * 100);
                                    } else if (badge.id === 'millionaire') {
                                        current = userPoints[currentUser.uid] || 0;
                                        progress = Math.min(100, (current / badge.target) * 100);
                                    } else if (badge.id === 'friendship') {
                                        current = userFollowing[currentUser.uid]?.length || 0;
                                        progress = Math.min(100, (current / badge.target) * 100);
                                    } else if (badge.id === 'popular') {
                                        current = userFollowers[currentUser.uid]?.length || 0;
                                        progress = Math.min(100, (current / badge.target) * 100);
                                    } else {
                                        current = myAttendance;
                                        progress = Math.min(100, (myAttendance / badge.target) * 100);
                                    }
                                    
                                    return `
                                        <div class="glass-card p-4 text-center opacity-75 hover:opacity-100 transition group" style="border: 1px solid ${badge.color}">
                                            <div class="text-5xl mb-2 filter grayscale group-hover:grayscale-0 transition-all duration-300">${badge.icon}</div>
                                            <h4 class="font-bold text-sm">${badge.name}</h4>
                                            <p class="text-xs text-gray-400 mt-1">${badge.desc}</p>
                                            <p class="text-xs text-yellow-400 mt-2">+${badge.points} points</p>
                                            
                                            <div class="mt-2">
                                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                                    <span>${current}/${badge.target}</span>
                                                    <span>${Math.round(progress)}%</span>
                                                </div>
                                                <div class="w-full bg-white/10 rounded-full h-2">
                                                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-2 rounded-full" style="width: ${progress}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${userRole === 'developer' ? `
                                <div class="dev-power-section mt-8">
                                    <h3 class="text-xl font-bold mb-4 text-pink-400">‚ö° Developer Power</h3>
                                    <div class="grid gap-3">
                                        <div>
                                            <select id="dev-badge-user" class="w-full mb-2 p-2 rounded text-sm">
                                                <option value="">Pilih user</option>
                                                ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                                            </select>
                                            <select id="dev-badge-id" class="w-full mb-2 p-2 rounded text-sm">
                                                ${badges.map(b => `<option value="${b.id}">${b.name} ${b.icon}</option>`).join('')}
                                            </select>
                                            <button onclick="devAddBadge(document.getElementById('dev-badge-user').value, document.getElementById('dev-badge-id').value)" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 p-3 rounded-lg font-semibold mb-2">
                                                Tambah Badge
                                            </button>
                                        </div>
                                        <div>
                                            <input type="text" id="dev-title" placeholder="Title (contoh: The King)" class="w-full mb-2 p-2 rounded text-sm">
                                            <button onclick="devAddTitle(document.getElementById('dev-badge-user').value, document.getElementById('dev-title').value)" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 p-3 rounded-lg font-semibold">
                                                Tambah Title
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        ` : `
                            <div class="text-center p-8 bg-yellow-600/20 rounded-lg">
                                <p class="text-yellow-400 mb-3">Silakan login untuk melihat badge dan level Anda</p>
                                <button onclick="toggleLoginModal()" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg">
                                    Login Sekarang
                                </button>
                            </div>
                        `}
                    </div>
                </section>
            `;
        }

        function renderBadgeUseModal() {
            if (!selectedBadge) return '';
            
            const badge = badges.find(b => b.id === selectedBadge);
            if (!badge) return '';
            
            const isEquipped = userEquippedBadge[currentUser?.uid] === badge.id;
            
            return `
                <div class="modal" onclick="if(event.target === this) toggleBadgeUseModal()">
                    <div class="modal-content text-center" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">${badge.name}</h3>
                            <button onclick="toggleBadgeUseModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <div class="text-8xl mb-4" style="filter: drop-shadow(0 0 20px ${badge.color});">${badge.icon}</div>
                        
                        <p class="text-gray-300 mb-2">${badge.desc}</p>
                        <p class="text-yellow-400 mb-4">+${badge.points} points</p>
                        
                        <div class="flex gap-3">
                            <button onclick="equipBadge('${badge.id}')" class="flex-1 gradient-bg p-3 rounded-lg font-semibold">
                                ${isEquipped ? 'Lepas Badge' : 'Pasang Badge'}
                            </button>
                            <button onclick="toggleBadgeUseModal()" class="flex-1 bg-gray-600 p-3 rounded-lg font-semibold">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMissionsPage() {
            const myAttendance = currentUser ? attendanceHistory.filter(a => a.userId === currentUser.uid).length : 0;
            const userProjects = currentUser ? projects.filter(p => p.createdBy === currentUser.uid).length : 0;
            const userChats = currentUser ? chats.filter(c => c.userId === currentUser.uid).length : 0;
            const consecutive = userConsecutiveDays[currentUser?.uid] || 0;
            const earlyBird = userEarlyBird[currentUser?.uid] || 0;
            const nightOwl = userNightOwl[currentUser?.uid] || 0;
            const points = userPoints[currentUser?.uid] || 0;
            const followers = userFollowers[currentUser?.uid]?.length || 0;
            const following = userFollowing[currentUser?.uid]?.length || 0;
            const userCompleted = currentUser ? (userMissions[currentUser.uid]?.completed || []) : [];
            const userClaimed = currentUser ? (userMissions[currentUser.uid]?.claimed || []) : [];
            
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 roboto-font" data-aos="fade-up">
                            <span class="neon-text">üéØ Misi & Reward</span>
                        </h2>
                        
                        ${currentUser ? `
                            <div class="glass-card p-6 mb-6" data-aos="fade-up">
                                <h3 class="text-lg font-bold mb-4">Progress Anda</h3>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    <div>
                                        <p class="text-gray-400">Kehadiran</p>
                                        <p class="text-2xl font-bold text-blue-400">${myAttendance}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Proyek</p>
                                        <p class="text-2xl font-bold text-green-400">${userProjects}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Chat</p>
                                        <p class="text-2xl font-bold text-purple-400">${userChats}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Berturut-turut</p>
                                        <p class="text-2xl font-bold text-yellow-400">${consecutive}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Points</p>
                                        <p class="text-2xl font-bold text-orange-400">${points}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Followers</p>
                                        <p class="text-2xl font-bold text-pink-400">${followers}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Following</p>
                                        <p class="text-2xl font-bold text-indigo-400">${following}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Misi Selesai</p>
                                        <p class="text-2xl font-bold text-teal-400">${userCompleted.length}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4" data-aos="fade-up">
                                ${missions.map(mission => {
                                    const isCompleted = userCompleted.includes(mission.id);
                                    const isClaimed = userClaimed.includes(mission.id);
                                    const canClaim = isCompleted && !isClaimed;
                                    
                                    let progress = 0;
                                    let current = 0;
                                    if (mission.type === 'attendance') {
                                        current = myAttendance;
                                        progress = Math.min(100, (myAttendance / mission.requirement) * 100);
                                    } else if (mission.type === 'project') {
                                        current = userProjects;
                                        progress = Math.min(100, (userProjects / mission.requirement) * 100);
                                    } else if (mission.type === 'consecutive') {
                                        current = consecutive;
                                        progress = Math.min(100, (consecutive / mission.requirement) * 100);
                                    } else if (mission.type === 'early') {
                                        current = earlyBird;
                                        progress = Math.min(100, (earlyBird / mission.requirement) * 100);
                                    } else if (mission.type === 'night') {
                                        current = nightOwl;
                                        progress = Math.min(100, (nightOwl / mission.requirement) * 100);
                                    } else if (mission.type === 'chat') {
                                        current = userChats;
                                        progress = Math.min(100, (userChats / mission.requirement) * 100);
                                    } else if (mission.type === 'points') {
                                        current = points;
                                        progress = Math.min(100, (points / mission.requirement) * 100);
                                    } else if (mission.type === 'follow') {
                                        current = following;
                                        progress = Math.min(100, (following / mission.requirement) * 100);
                                    } else if (mission.type === 'follower') {
                                        current = followers;
                                        progress = Math.min(100, (followers / mission.requirement) * 100);
                                    } else {
                                        current = myAttendance;
                                        progress = Math.min(100, (myAttendance / mission.requirement) * 100);
                                    }
                                    
                                    const badge = badges.find(b => b.id === mission.reward);
                                    
                                    return `
                                        <div class="glass-card p-5 relative ${canClaim ? 'badge-claimable' : ''}" style="${canClaim ? 'border: 2px solid gold;' : ''}">
                                            <div class="flex items-start justify-between">
                                                <div class="flex items-center space-x-3">
                                                    <div class="text-4xl">${mission.icon}</div>
                                                    <div>
                                                        <h4 class="font-bold">${mission.name}</h4>
                                                        <p class="text-xs text-gray-400">${mission.desc}</p>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-sm font-semibold">Hadiah:</div>
                                                    <div class="flex items-center space-x-1">
                                                        <span class="text-2xl">${badge?.icon}</span>
                                                        <span class="text-xs">${badge?.name}</span>
                                                        <span class="text-xs text-yellow-400">+${mission.points}‚≠ê</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                                    <span>Progress: ${current}/${mission.requirement}</span>
                                                    <span>${Math.round(progress)}%</span>
                                                </div>
                                                <div class="w-full bg-white/10 rounded-full h-2">
                                                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full" style="width: ${progress}%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3 flex justify-between items-center">
                                                <div>
                                                    ${isClaimed ? `
                                                        <span class="bg-green-600 text-xs px-3 py-1 rounded-full">‚úì Sudah Diklaim</span>
                                                    ` : isCompleted ? `
                                                        <span class="bg-yellow-600 text-xs px-3 py-1 rounded-full">‚≠ê Siap Diklaim</span>
                                                    ` : `
                                                        <span class="bg-gray-600 text-xs px-3 py-1 rounded-full">‚è≥ Belum Selesai</span>
                                                    `}
                                                </div>
                                                
                                                ${canClaim ? `
                                                    <button onclick="claimMissionReward('${mission.id}')" class="bg-gradient-to-r from-yellow-500 to-orange-500 px-4 py-2 rounded-lg text-sm font-bold hover:scale-105 transition">
                                                        Klaim Reward
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="text-center p-8 bg-yellow-600/20 rounded-lg">
                                <p class="text-yellow-400 mb-3">Silakan login untuk melihat misi</p>
                                <button onclick="toggleLoginModal()" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg">
                                    Login Sekarang
                                </button>
                            </div>
                        `}
                    </div>
                </section>
            `;
        }

        function renderAttendancePage() {
            const today = moment().format('YYYY-MM-DD');
            const todayAttendance = attendanceHistory.filter(a => a.date === today);
            const totalHadirHariIni = todayAttendance.length;
            const myAttendance = currentUser ? attendanceHistory.filter(a => a.userId === currentUser.uid).length : 0;
            const myLevel = currentUser ? calculateLevel(myAttendance) : { level: 0, title: 'Baru', icon: 'üÜï' };
            
            const availableMembers = currentUser ? members.filter(m => 
                !todayAttendance.some(a => a.userId === m.id)
            ) : [];
            
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 roboto-font" data-aos="fade-up">
                            <span class="neon-text">Absensi Kehadiran</span>
                        </h2>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 mb-6" data-aos="fade-up">
                            <div class="glass-card p-2 sm:p-4 text-center hover-scale">
                                <div class="text-lg sm:text-2xl md:text-3xl font-bold text-blue-400">${totalHadirHariIni}</div>
                                <div class="text-xs sm:text-sm">Hadir Hari Ini</div>
                            </div>
                            <div class="glass-card p-2 sm:p-4 text-center hover-scale">
                                <div class="text-lg sm:text-2xl md:text-3xl font-bold text-blue-400">${attendanceHistory.length}</div>
                                <div class="text-xs sm:text-sm">Total Absensi</div>
                            </div>
                            <div class="glass-card p-2 sm:p-4 text-center hover-scale">
                                <div class="text-lg sm:text-2xl md:text-3xl font-bold text-blue-400">${members.length}</div>
                                <div class="text-xs sm:text-sm">Total Anggota</div>
                            </div>
                            <div class="glass-card p-2 sm:p-4 text-center hover-scale">
                                <div class="text-lg sm:text-2xl md:text-3xl font-bold text-blue-400">${myAttendance}</div>
                                <div class="text-xs sm:text-sm">Absensi Saya</div>
                                <div class="text-xs text-blue-400 mt-1">${myLevel.icon} Level ${myLevel.level} ‚Ä¢ ${myLevel.title}</div>
                            </div>
                        </div>
                        
                        <div class="glass-card p-4 sm:p-6 mb-6" data-aos="fade-up">
                            <div class="text-center mb-4">
                                <i class="fas fa-calendar-alt text-3xl text-blue-400 mb-2"></i>
                                <h3 class="text-base sm:text-lg font-bold">${moment().format('dddd, DD MMMM YYYY')}</h3>
                            </div>
                            
                            ${currentUser ? `
                                ${availableMembers.length > 0 ? `
                                    <div class="space-y-4">
                                        <p class="text-sm text-gray-300">Pilih nama untuk absen (+10 points):</p>
                                        
                                        <select id="attendance-member-select" class="w-full p-3 rounded-lg text-sm">
                                            <option value="">-- Pilih Anggota --</option>
                                            ${availableMembers.map(m => {
                                                const level = calculateLevel(attendanceHistory.filter(a => a.userId === m.id).length);
                                                return `
                                                    <option value="${m.id}" data-name="${m.name}" data-class="${m.class || ''}" data-photo="${m.photo}">
                                                        ${m.name} - ${m.class || 'Kelas belum diisi'} (${level.icon} Level ${level.level})
                                                    </option>
                                                `;
                                            }).join('')}
                                        </select>
                                        
                                        <div class="text-center text-xs text-gray-400">- atau -</div>
                                        
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <input type="text" id="attendance-manual-name" placeholder="Nama (jika tidak ada di daftar)" class="w-full p-3 rounded-lg text-sm">
                                            <input type="text" id="attendance-manual-class" placeholder="Kelas" class="w-full p-3 rounded-lg text-sm">
                                        </div>
                                        
                                        <button onclick="submitAttendance()" class="w-full gradient-bg p-3 sm:p-4 rounded-lg font-semibold hover:scale-105 transition text-sm sm:text-base">
                                            <i class="fas fa-check-circle mr-2"></i>Konfirmasi Kehadiran (+10‚≠ê)
                                        </button>
                                    </div>
                                ` : `
                                    <div class="text-center p-3 sm:p-4 bg-green-600/20 rounded-lg">
                                        <i class="fas fa-check-circle text-green-400 text-xl sm:text-2xl mb-2"></i>
                                        <p class="text-green-400 text-sm sm:text-base">Semua anggota sudah absen hari ini!</p>
                                    </div>
                                `}
                            ` : `
                                <div class="text-center p-4 sm:p-6 bg-yellow-600/20 rounded-lg">
                                    <i class="fas fa-lock text-yellow-400 text-3xl mb-3"></i>
                                    <p class="text-yellow-400 text-base sm:text-lg mb-3">Silakan login untuk absensi</p>
                                    <button onclick="toggleLoginModal()" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg text-sm sm:text-base font-semibold">
                                        <i class="fas fa-sign-in-alt mr-2"></i>Login Sekarang
                                    </button>
                                </div>
                            `}
                        </div>
                        
                        <div class="glass-card p-4 sm:p-6 mb-6" data-aos="fade-up" data-aos-delay="50">
                            <h3 class="text-base sm:text-lg font-bold mb-3">üìã Daftar Hadir Hari Ini</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${todayAttendance.length > 0 ? todayAttendance.map(a => `
                                    <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg hover-scale">
                                        <div class="flex items-center space-x-2">
                                            <img src="${a.photo}" class="w-8 h-8 rounded-full" onerror="this.src='https://ui-avatars.com/api/?name=${a.name}&background=00d4ff&color=fff'">
                                            <div>
                                                <p class="font-semibold text-sm">${a.name}</p>
                                                <p class="text-xs text-gray-400">${a.class || '-'} ‚Ä¢ ${a.time}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <p class="text-gray-400 text-center py-4 text-sm">Belum ada yang hadir hari ini</p>
                                `}
                            </div>
                        </div>
                        
                        <div class="glass-card p-4 sm:p-6" data-aos="fade-up" data-aos-delay="100">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-base sm:text-lg font-bold">üìÖ Riwayat Absensi Lengkap</h3>
                                ${(userRole === 'developer' || userRole === 'admin') ? `
                                    <button onclick="exportAttendanceToExcel()" class="bg-green-600 hover:bg-green-700 px-2 sm:px-3 py-1 rounded-lg text-xs sm:text-sm flex items-center">
                                        <i class="fas fa-download mr-1"></i> Export
                                    </button>
                                ` : ''}
                            </div>
                            
                            <div class="overflow-x-auto -mx-4 sm:mx-0 px-4 sm:px-0">
                                <table class="attendance-table min-w-[500px] sm:min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="p-2 sm:p-3 text-xs sm:text-sm">Tanggal</th>
                                            <th class="p-2 sm:p-3 text-xs sm:text-sm">Hari</th>
                                            <th class="p-2 sm:p-3 text-xs sm:text-sm">Jam</th>
                                            <th class="p-2 sm:p-3 text-xs sm:text-sm">Nama</th>
                                            <th class="p-2 sm:p-3 text-xs sm:text-sm">Kelas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${attendanceHistory.slice(0, 50).map(a => `
                                            <tr>
                                                <td class="p-2 sm:p-3 text-xs sm:text-sm">${a.date}</td>
                                                <td class="p-2 sm:p-3 text-xs sm:text-sm">${moment(a.date).format('dddd')}</td>
                                                <td class="p-2 sm:p-3 text-xs sm:text-sm">${a.time}</td>
                                                <td class="p-2 sm:p-3 text-xs sm:text-sm">${a.name}</td>
                                                <td class="p-2 sm:p-3 text-xs sm:text-sm">${a.class || '-'}</td>
                                            </tr>
                                        `).join('')}
                                        ${attendanceHistory.length === 0 ? `
                                            <tr><td colspan="5" class="text-center py-4 text-gray-400 text-xs sm:text-sm">Belum ada riwayat absensi</td></tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                            
                            ${attendanceHistory.length > 50 ? `
                                <div class="text-center mt-4">
                                    <button onclick="showAttendanceHistoryModal = true; renderMainContent()" class="text-blue-400 hover:text-blue-300 text-xs sm:text-sm">
                                        Tampilkan semua (${attendanceHistory.length} data)...
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </section>
            `;
        }

        function renderMembersPage() {
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 roboto-font" data-aos="fade-up">
                            <span class="neon-text">Anggota Ekskul</span>
                        </h2>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 sm:gap-4">
                            ${members.length > 0 ? members.map((member, index) => {
                                const userAttendance = attendanceHistory.filter(a => a.userId === member.id).length;
                                const level = calculateLevel(userAttendance);
                                const userBadgeList = userBadges[member.id]?.badges || [];
                                const isDeveloper = member.role === 'developer';
                                const isAdmin = member.role === 'admin';
                                const isFollowing = currentUser && userFollowing[currentUser.uid]?.includes(member.id);
                                
                                return `
                                    <div class="glass-card p-3 sm:p-4 hover-scale relative cursor-pointer" data-aos="fade-up" data-aos-delay="${index * 30}" onclick="viewMemberProfile('${member.id}')">
                                        ${(userRole === 'developer' || userRole === 'admin') ? `
                                            <div class="absolute top-2 right-2 flex space-x-1" onclick="event.stopPropagation()">
                                                <button onclick="deleteMember('${member.id}')" class="action-btn delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        ` : ''}
                                        <div class="relative">
                                            <img src="${member.photo}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 border-2 border-blue-400"
                                                 onerror="this.src='https://ui-avatars.com/api/?name=${member.name}&background=00d4ff&color=fff'">
                                        </div>
                                        <h3 class="font-bold text-center text-sm sm:text-base">${member.name}</h3>
                                        <p class="text-xs text-blue-400 text-center">${member.class || '-'}</p>
                                        <p class="text-xs text-gray-400 text-center mb-2">
                                            ${isDeveloper ? 'üë®‚Äçüíª Developer' : (isAdmin ? 'üëë Admin' : (member.role || 'üë§ Anggota'))}
                                        </p>
                                        
                                        <div class="text-center mt-1">
                                            <span class="level-badge">${level.icon} Level ${level.level} ‚Ä¢ ${level.title}</span>
                                        </div>
                                        
                                        <p class="text-xs text-center text-blue-300 mt-1">
                                            <i class="fas fa-calendar-check mr-1"></i>${userAttendance} kehadiran
                                        </p>
                                        <p class="text-xs text-center text-yellow-400 mt-1">
                                            ‚≠ê ${userPoints[member.id] || 0} points
                                        </p>
                                        
                                        ${userBadgeList.length > 0 ? `
                                            <div class="flex justify-center space-x-1 mt-2">
                                                ${userBadgeList.slice(0, 3).map(badgeId => {
                                                    const badge = badges.find(b => b.id === badgeId);
                                                    return badge ? `<span title="${badge.name}" class="text-sm" style="filter: drop-shadow(0 0 5px ${badge.color});">${badge.icon}</span>` : '';
                                                }).join('')}
                                                ${userBadgeList.length > 3 ? '<span class="text-xs text-gray-400">+'+ (userBadgeList.length-3) +'</span>' : ''}
                                            </div>
                                        ` : ''}
                                        
                                        ${userEquippedBadge[member.id] ? `
                                            <div class="absolute top-2 left-2">
                                                <span class="text-xs bg-gradient-to-r from-yellow-600 to-orange-600 px-2 py-1 rounded-full">‚òÖ</span>
                                            </div>
                                        ` : ''}
                                        
                                        ${currentUser && currentUser.uid !== member.id ? `
                                            <button onclick="event.stopPropagation(); followUser('${member.id}')" class="mt-2 w-full text-xs ${isFollowing ? 'bg-red-600' : 'bg-blue-600'} py-1 rounded-full">
                                                ${isFollowing ? 'Unfollow' : 'Follow'}
                                            </button>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('') : `
                                <p class="text-gray-400 text-center col-span-4">Belum ada anggota</p>
                            `}
                        </div>
                    </div>
                </section>
            `;
        }

        function renderProjectsPage() {
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold roboto-font" data-aos="fade-up">
                                <span class="neon-text">Proyek Robotik</span>
                            </h2>
                            ${(userRole === 'developer' || userRole === 'admin') ? `
                                <button onclick="showAddProjectModal = true; renderMainContent()" 
                                    class="gradient-bg px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base">
                                    <i class="fas fa-plus mr-1"></i>Tambah Proyek
                                </button>
                            ` : ''}
                        </div>
                        
                        <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
                            ${projects.length > 0 ? projects.map((project, index) => `
                                <div class="glass-card overflow-hidden hover-scale relative" data-aos="fade-up" data-aos-delay="${index * 50}">
                                    ${(userRole === 'developer' || userRole === 'admin') ? `
                                        <div class="absolute top-2 right-2 flex space-x-1 z-10">
                                            <button onclick="editProject(${JSON.stringify(project).replace(/"/g, '&quot;')})" class="action-btn edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteProject('${project.id}')" class="action-btn delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    ` : ''}
                                    <img src="${project.image || 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e'}" class="w-full h-36 sm:h-40 object-cover">
                                    <div class="p-3 sm:p-4">
                                        <div class="flex justify-between items-start mb-2">
                                            <h3 class="text-sm sm:text-base font-bold">${project.name}</h3>
                                            <span class="text-xs ${project.status === 'Selesai' ? 'bg-green-600' : 'bg-yellow-600'} px-2 py-1 rounded">
                                                ${project.status || 'Development'}
                                            </span>
                                        </div>
                                        <p class="text-xs text-gray-400 mb-2">Tim: ${project.team || '-'}</p>
                                        <p class="text-xs sm:text-sm mb-2">${project.description || ''}</p>
                                        <p class="text-xs text-gray-400"><i class="fas fa-users mr-1"></i>${project.members || 0} anggota</p>
                                    </div>
                                </div>
                            `).join('') : `
                                <p class="text-gray-400 text-center col-span-3 py-10">
                                    Belum ada proyek. 
                                    ${(userRole === 'developer' || userRole === 'admin') ? 
                                        'Klik tombol Tambah Proyek untuk memulai.' : 
                                        'Hubungi admin untuk menambahkan proyek.'}
                                </p>
                            `}
                        </div>
                    </div>
                </section>
            `;
        }

        function renderSchedulePage() {
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold roboto-font" data-aos="fade-up">
                                <span class="neon-text">Jadwal Ekskul</span>
                            </h2>
                            ${(userRole === 'developer' || userRole === 'admin') ? `
                                <button onclick="showAddScheduleModal = true; renderMainContent()" 
                                    class="gradient-bg px-3 sm:px-4 py-2 rounded-lg text-sm sm:text-base">
                                    <i class="fas fa-plus mr-1"></i>Tambah Jadwal
                                </button>
                            ` : ''}
                        </div>
                        
                        <div class="glass-card p-4 sm:p-6" data-aos="fade-up">
                            <div class="space-y-3">
                                ${schedules.length > 0 ? schedules.map(s => `
                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg hover-scale">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3">
                                                <span class="font-bold text-blue-400 w-16">${s.day}</span>
                                                <span class="text-sm">${s.time}</span>
                                            </div>
                                            <div class="text-sm mt-1">
                                                <p class="font-semibold">${s.activity}</p>
                                                <p class="text-xs text-gray-400">Oleh: ${s.instructor}</p>
                                            </div>
                                        </div>
                                        ${(userRole === 'developer' || userRole === 'admin') ? `
                                            <div class="flex space-x-1">
                                                <button onclick="editSchedule(${JSON.stringify(s).replace(/"/g, '&quot;')})" class="action-btn edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteSchedule('${s.id}')" class="action-btn delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('') : `
                                    <p class="text-gray-400 text-center py-4">
                                        Belum ada jadwal. 
                                        ${(userRole === 'developer' || userRole === 'admin') ? 
                                            'Klik tombol Tambah Jadwal untuk menambahkan.' : 
                                            'Hubungi admin untuk menambahkan jadwal.'}
                                    </p>
                                `}
                            </div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderTeachersPage() {
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 sm:mb-12 roboto-font" data-aos="fade-up">
                            <span class="neon-text">Pembina Ekskul</span>
                        </h2>
                        
                        <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
                            ${teachers.length > 0 ? teachers.map((teacher, index) => `
                                <div class="glass-card p-4 sm:p-5 hover-scale relative" data-aos="fade-up" data-aos-delay="${index * 50}">
                                    ${(userRole === 'developer' || userRole === 'admin') ? `
                                        <div class="absolute top-2 right-2 flex space-x-1">
                                            <button onclick="editTeacher(${JSON.stringify(teacher).replace(/"/g, '&quot;')})" class="action-btn edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteTeacher('${teacher.id}')" class="action-btn delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    ` : ''}
                                    <img src="${teacher.photo}" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full mx-auto mb-3 border-3 border-blue-400"
                                         onerror="this.src='https://ui-avatars.com/api/?name=${teacher.name}&background=00d4ff&color=fff'">
                                    <h3 class="text-base sm:text-lg font-bold text-center">${teacher.name}</h3>
                                    <p class="text-xs sm:text-sm text-blue-400 text-center mb-2">${teacher.role}</p>
                                    <p class="text-xs sm:text-sm text-gray-300 text-center mb-3">${teacher.bio || ''}</p>
                                    <div class="flex justify-center space-x-1 flex-wrap">
                                        ${teacher.expertise ? teacher.expertise.map(skill => `
                                            <span class="text-xs bg-white/10 px-2 py-1 rounded m-1">${skill}</span>
                                        `).join('') : ''}
                                    </div>
                                </div>
                            `).join('') : `
                                <p class="text-gray-400 text-center col-span-3">Belum ada data pembina</p>
                            `}
                        </div>
                    </div>
                </section>
            `;
        }

        function renderLeaderboardPage() {
            calculateLeaderboard();
            
            return `
                <section class="py-10 sm:py-16 px-4">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-8 roboto-font" data-aos="fade-up">
                            <span class="neon-text">üìä Leaderboard</span>
                        </h2>
                        
                        <div class="glass-card p-6" data-aos="fade-up">
                            <div class="space-y-3">
                                ${leaderboardData.length > 0 ? leaderboardData.slice(0, 20).map((member, index) => {
                                    const isCurrentUser = currentUser && member.id === currentUser.uid;
                                    let medalClass = '';
                                    let medalIcon = '';
                                    
                                    if (index === 0) {
                                        medalClass = 'medal-1';
                                        medalIcon = 'ü•á';
                                    } else if (index === 1) {
                                        medalClass = 'medal-2';
                                        medalIcon = 'ü•à';
                                    } else if (index === 2) {
                                        medalClass = 'medal-3';
                                        medalIcon = 'ü•â';
                                    } else {
                                        medalIcon = `${index + 1}.`;
                                    }
                                    
                                    return `
                                        <div class="flex items-center justify-between p-3 ${isCurrentUser ? 'bg-blue-600/20' : 'bg-white/5'} rounded-lg hover:bg-white/10 transition cursor-pointer" onclick="viewMemberProfile('${member.id}')">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-xl font-bold w-8 ${medalClass} px-2 py-1 rounded-full text-center">${medalIcon}</span>
                                                <img src="${member.photo}" class="w-10 h-10 rounded-full"
                                                     onerror="this.src='https://ui-avatars.com/api/?name=${member.name}&background=00d4ff&color=fff'">
                                                <div>
                                                    <p class="font-semibold">${member.name} ${isCurrentUser ? '(Anda)' : ''}</p>
                                                    <p class="text-xs text-gray-400">${member.class || '-'} ‚Ä¢ ${member.level.icon} Level ${member.level.level}</p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xl font-bold text-blue-400">${member.attendance}</p>
                                                <p class="text-xs text-gray-400">kehadiran</p>
                                                <p class="text-xs text-yellow-400">‚≠ê ${member.points}</p>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : `
                                    <p class="text-gray-400 text-center py-8">Belum ada data leaderboard</p>
                                `}
                            </div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderChatModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleChatModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">üí¨ Chat Room</h3>
                            <button onclick="toggleChatModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <div class="chat-container mb-4" id="chat-modal-container">
                            ${chats.slice(-50).map(chat => `
                                <div class="chat-message ${chat.userId === currentUser?.uid ? 'own' : ''}">
                                    <div class="chat-bubble">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <img src="${chat.userPhoto}" class="w-5 h-5 rounded-full">
                                            <span class="text-xs font-semibold">${chat.userName}</span>
                                        </div>
                                        <p class="text-sm">${chat.message}</p>
                                        <p class="chat-time">${chat.createdAt ? moment(chat.createdAt.toDate()).fromNow() : 'Baru saja'}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <form class="flex gap-2" onsubmit="event.preventDefault(); sendChat(document.getElementById('chat-modal-input').value); document.getElementById('chat-modal-input').value = ''">
                            <input type="text" id="chat-modal-input" placeholder="Tulis pesan..." class="flex-1 p-3 rounded-lg text-sm">
                            <button type="submit" class="gradient-bg px-6 py-3 rounded-lg font-semibold">
                                Kirim
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderMysteryBoxModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleMysteryBoxModal()">
                    <div class="modal-content text-center" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">üéÅ Mystery Box</h3>
                            <button onclick="toggleMysteryBoxModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <div class="mystery-box cost" id="mystery-box" onclick="openMysteryBox()">
                            üéÅ
                        </div>
                        
                        <p class="text-sm text-gray-400 mt-4">Klik box untuk membuka! (50‚≠ê)</p>
                        
                        <div class="grid grid-cols-5 gap-1 mt-4 text-xs">
                            <div class="p-1 bg-white/5 rounded">
                                <span class="text-xl">üå±</span>
                                <p>Common</p>
                                <p class="text-gray-500">50%</p>
                            </div>
                            <div class="p-1 bg-white/5 rounded">
                                <span class="text-xl">üî•</span>
                                <p>Uncommon</p>
                                <p class="text-gray-500">25%</p>
                            </div>
                            <div class="p-1 bg-white/5 rounded">
                                <span class="text-xl">‚ö°</span>
                                <p>Rare</p>
                                <p class="text-gray-500">15%</p>
                            </div>
                            <div class="p-1 bg-white/5 rounded">
                                <span class="text-xl">üéñÔ∏è</span>
                                <p>Epic</p>
                                <p class="text-gray-500">7%</p>
                            </div>
                            <div class="p-1 bg-white/5 rounded">
                                <span class="text-xl">üèÜ</span>
                                <p>Legendary</p>
                                <p class="text-gray-500">3%</p>
                            </div>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">Bisa dapat badge langka, points, atau title spesial!</p>
                    </div>
                </div>
            `;
        }

        function renderQRModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleQRModal()">
                    <div class="modal-content text-center" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">üì± QR Code Saya</h3>
                            <button onclick="toggleQRModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <canvas id="qr-code-container" class="qr-code"></canvas>
                        
                        <p class="text-sm text-gray-400 mt-4">Scan untuk melihat profil</p>
                        <p class="text-xs text-gray-500 mt-2">${currentUser?.displayName || userData?.name}</p>
                        
                        <button onclick="downloadQRCode()" class="w-full mt-4 gradient-bg p-3 rounded-lg font-semibold">
                            Download QR Code
                        </button>
                    </div>
                </div>
            `;
        }

        function renderStoryModal() {
            if (!selectedStory) return '';
            
            return `
                <div class="modal" onclick="if(event.target === this) toggleStoryModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Story</h3>
                            <button onclick="toggleStoryModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <div class="text-center">
                            <img src="${selectedStory.image}" class="w-full rounded-lg mb-4">
                            <p class="font-semibold">${selectedStory.userName}</p>
                            <p class="text-xs text-gray-400">${selectedStory.createdAt ? moment(selectedStory.createdAt.toDate()).fromNow() : 'Baru saja'}</p>
                            <p class="text-xs text-gray-500 mt-2">Dilihat ${selectedStory.views?.length || 0} kali</p>
                        </div>
                        
                        <button onclick="toggleStoryModal()" class="w-full mt-4 bg-blue-600 p-3 rounded-lg font-semibold">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
        }

        function renderFeedModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleFeedModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">üìù Buat Postingan</h3>
                            <button onclick="toggleFeedModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="event.preventDefault(); createFeed({ content: document.getElementById('feed-content').value, image: document.getElementById('feed-image').value }); toggleFeedModal();">
                            <div class="mb-3">
                                <textarea id="feed-content" rows="4" placeholder="Apa yang Anda pikirkan?" class="w-full p-3 rounded-lg text-sm" required></textarea>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-xs sm:text-sm mb-1">Foto (Opsional)</label>
                                
                                <div class="photo-preview-container mb-2">
                                    <img id="feed-preview" class="photo-preview" style="display: none;">
                                    <div class="photo-preview-placeholder" id="feed-placeholder">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Klik tombol upload untuk memilih foto</p>
                                    </div>
                                </div>
                                
                                <button type="button" onclick="uploadFeedPhoto()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-lg text-sm mb-2">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Foto
                                </button>
                                
                                <input type="hidden" id="feed-image">
                            </div>
                            
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Posting
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderLoginModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleLoginModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Login</h3>
                            <button onclick="toggleLoginModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <button onclick="loginWithGoogle()" class="w-full bg-red-600 text-white p-3 rounded-lg mb-4 hover:bg-red-700 flex items-center justify-center space-x-2 text-sm sm:text-base">
                            <i class="fab fa-google"></i>
                            <span>Login dengan Google</span>
                        </button>
                        
                        <div class="relative my-4">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-white/20"></div>
                            </div>
                            <div class="relative flex justify-center">
                                <span class="bg-[#1a1f35] px-4 text-xs sm:text-sm text-gray-400">atau</span>
                            </div>
                        </div>
                        
                        <form onsubmit="loginWithEmail(event)">
                            <div class="mb-3">
                                <input type="email" id="login-email" placeholder="Email" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-4">
                                <input type="password" id="login-password" placeholder="Password" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Login
                            </button>
                        </form>
                        
                        <div class="mt-4 text-center space-y-2">
                            <button onclick="toggleForgotModal()" class="text-xs sm:text-sm text-blue-400 hover:underline">
                                Lupa Password?
                            </button>
                            <p class="text-xs sm:text-sm text-gray-400">
                                Belum punya akun? 
                                <button onclick="toggleRegisterModal()" class="text-blue-400 hover:underline">
                                    Daftar
                                </button>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRegisterModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleRegisterModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Daftar Akun Baru (+100‚≠ê)</h3>
                            <button onclick="toggleRegisterModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="register(event)">
                            <div class="mb-3">
                                <input type="text" id="register-name" placeholder="Nama Lengkap" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="email" id="register-email" placeholder="Email" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <select id="register-class" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="">Pilih Kelas</option>
                                    <option value="X RPL">X RPL</option>
                                    <option value="X TJKT">X TJKT</option>
                                    <option value="X AKUNTANSI">X AKUNTANSI</option>
                                    <option value="X PERHOTELAN">X PERHOTELAN</option>
                                    <option value="X DKV">X DKV</option>
                                    <option value="XI RPL">XI RPL</option>
                                    <option value="XI TJKT">XI TJKT</option>
                                    <option value="XI AKUNTANSI">XI AKUNTANSI</option>
                                    <option value="XI PERHOTELAN">XI PERHOTELAN</option>
                                    <option value="XI DKV">XI DKV</option>
                                    <option value="XII RPL">XII RPL</option>
                                    <option value="XII TJKT">XII TJKT</option>
                                    <option value="XII AKUNTANSI">XII AKUNTANSI</option>
                                    <option value="XII PERHOTELAN">XII PERHOTELAN</option>
                                    <option value="XII DKV">XII DKV</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <input type="password" id="register-password" placeholder="Password" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-4">
                                <input type="password" id="register-confirm" placeholder="Konfirmasi Password" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Daftar (+100‚≠ê)
                            </button>
                        </form>
                        
                        <p class="mt-4 text-center text-xs sm:text-sm text-gray-400">
                            Sudah punya akun? 
                            <button onclick="toggleLoginModal()" class="text-blue-400 hover:underline">
                                Login
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }

        function renderForgotModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleForgotModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Lupa Password</h3>
                            <button onclick="toggleForgotModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-4">Masukkan email untuk reset password.</p>
                        
                        <form onsubmit="forgotPassword(event)">
                            <div class="mb-4">
                                <input type="email" id="forgot-email" placeholder="Email" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Kirim Reset
                            </button>
                        </form>
                        
                        <button onclick="toggleLoginModal()" class="mt-4 text-sm text-blue-400 hover:underline">
                            Kembali ke Login
                        </button>
                    </div>
                </div>
            `;
        }

        function renderEditProfileModal() {
            const isViewingOther = selectedMember && selectedMember.id !== currentUser?.uid;
            const profileData = selectedMember || userData || currentUser;
            
            return `
                <div class="modal" onclick="if(event.target === this) { ${isViewingOther ? 'selectedMember = null;' : ''} toggleEditProfileModal() }">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">${isViewingOther ? 'Profil Anggota' : 'Edit Profile'}</h3>
                            <button onclick="${isViewingOther ? 'selectedMember = null;' : ''} toggleEditProfileModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <div class="text-center mb-4">
                            <div class="relative inline-block">
                                <div class="photo-preview-container" style="width: 150px; height: 150px; margin: 0 auto;">
                                    <img src="${profileData?.photo || 'https://ui-avatars.com/api/?name=' + (profileData?.name || 'User')}" 
                                         class="photo-preview"
                                         id="profile-preview"
                                         style="max-height: 150px;"
                                         onerror="this.src='https://ui-avatars.com/api/?name=${profileData?.name}&background=00d4ff&color=fff'">
                                </div>
                                
                                ${!isViewingOther ? `
                                    <button onclick="uploadProfilePhoto()" class="camera-btn" title="Upload Foto">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                ` : ''}
                            </div>
                            
                            ${!isViewingOther ? `
                                <div class="mt-3 p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400 mb-2">üîó URL gambar (manual):</p>
                                    <div class="flex gap-2">
                                        <input type="url" id="profile-url-input" 
                                               placeholder="https://res.cloudinary.com/..." 
                                               class="flex-1 p-2 rounded-lg text-sm bg-white/10 border border-white/20 text-white"
                                               value="${profileData?.photo || ''}">
                                        <button onclick="document.getElementById('profile-preview').src = document.getElementById('profile-url-input').value"
                                                class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-sm">
                                            Preview
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 flex justify-center gap-2 flex-wrap">
                                <span class="level-badge">${profileData?.levelIcon || 'üÜï'} Level ${profileData?.level || 0}</span>
                                <span class="text-blue-400">${attendanceHistory.filter(a => a.userId === profileData?.id).length} hadir</span>
                                <span class="text-yellow-400">‚≠ê ${userPoints[profileData?.id] || 0} points</span>
                            </div>
                            
                            ${userEquippedBadge[profileData?.id] ? `
                                <div class="mt-2">
                                    ${(() => {
                                        const badge = badges.find(b => b.id === userEquippedBadge[profileData?.id]);
                                        return badge ? `<span class="text-2xl">${badge.icon}</span> <span class="text-xs">${badge.name}</span>` : '';
                                    })()}
                                </div>
                            ` : ''}
                            
                            ${userTitles[profileData?.id]?.length > 0 ? `
                                <div class="mt-2 flex gap-1 justify-center flex-wrap">
                                    ${userTitles[profileData?.id].map(title => `
                                        <span class="text-xs bg-gradient-to-r from-purple-600 to-pink-600 px-2 py-1 rounded-full">${title}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        ${isViewingOther ? `
                            <div class="space-y-3">
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Nama</p>
                                    <p class="font-semibold">${profileData?.name || '-'}</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Kelas</p>
                                    <p>${profileData?.class || '-'}</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Role</p>
                                    <p>${profileData?.role === 'developer' ? 'üë®‚Äçüíª Developer' : (profileData?.role === 'admin' ? 'üëë Admin' : (profileData?.role || 'üë§ Anggota'))}</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Bio</p>
                                    <p class="text-sm">${profileData?.bio || 'Belum ada bio'}</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Level</p>
                                    <p class="font-semibold text-blue-400">${profileData?.levelIcon || 'üÜï'} Level ${profileData?.level || 0}</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Kehadiran</p>
                                    <p class="font-semibold">${attendanceHistory.filter(a => a.userId === profileData?.id).length} kali</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Points</p>
                                    <p class="font-semibold text-yellow-400">‚≠ê ${userPoints[profileData?.id] || 0}</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Followers</p>
                                    <p class="font-semibold text-pink-400">${userFollowers[profileData?.id]?.length || 0}</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Following</p>
                                    <p class="font-semibold text-orange-400">${userFollowing[profileData?.id]?.length || 0}</p>
                                </div>
                                <div class="p-3 bg-white/5 rounded-lg">
                                    <p class="text-xs text-gray-400">Badges</p>
                                    <div class="flex gap-1 mt-1 flex-wrap">
                                        ${(userBadges[profileData?.id]?.badges || []).map(badgeId => {
                                            const badge = badges.find(b => b.id === badgeId);
                                            return badge ? `<span title="${badge.name}" class="text-2xl">${badge.icon}</span>` : '';
                                        }).join('')}
                                        ${(userBadges[profileData?.id]?.badges || []).length === 0 ? 'Belum ada badge' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${currentUser && currentUser.uid !== profileData?.id ? `
                                <button onclick="followUser('${profileData?.id}')" class="w-full mt-4 ${userFollowing[currentUser.uid]?.includes(profileData?.id) ? 'bg-red-600' : 'bg-blue-600'} p-3 rounded-lg font-semibold">
                                    ${userFollowing[currentUser.uid]?.includes(profileData?.id) ? 'Unfollow' : 'Follow'}
                                </button>
                            ` : ''}
                        ` : `
                            <form onsubmit="updateProfile(event)">
                                <div class="mb-3">
                                    <label class="block text-xs sm:text-sm mb-1">Nama Lengkap</label>
                                    <input type="text" id="edit-name" value="${profileData?.name || ''}" class="w-full p-3 rounded-lg text-sm" required>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-xs sm:text-sm mb-1">Kelas</label>
                                    <select id="edit-class" class="w-full p-3 rounded-lg text-sm">
                                        <option value="">Pilih Kelas</option>
                                        ${['X RPL','X TJKT','X AKUNTANSI','X PERHOTELAN','X DKV','XI RPL','XI TJKT','XI AKUNTANSI','XI PERHOTELAN','XI DKV','XII RPL','XII TJKT','XII AKUNTANSI','XII PERHOTELAN','XII DKV'].map(cls => 
                                            `<option value="${cls}" ${profileData?.class === cls ? 'selected' : ''}>${cls}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-xs sm:text-sm mb-1">Bio (Opsional)</label>
                                    <textarea id="edit-bio" rows="3" class="w-full p-3 rounded-lg text-sm">${profileData?.bio || ''}</textarea>
                                </div>
                                
                                <input type="hidden" id="edit-photo" value="${profileData?.photo || ''}">
                                
                                <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                    Simpan Perubahan
                                </button>
                            </form>
                        `}
                        
                        ${isViewingOther ? `
                            <button onclick="selectedMember = null; toggleEditProfileModal()" class="w-full mt-4 bg-blue-600 p-3 rounded-lg font-semibold">
                                Tutup
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderAddAdminModal() {
            const nonAdminMembers = members.filter(m => m.role !== 'admin' && m.role !== 'developer');
            
            return `
                <div class="modal" onclick="if(event.target === this) toggleAddAdminModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">üëë Jadikan Admin</h3>
                            <button onclick="toggleAddAdminModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="event.preventDefault(); makeAdmin(document.getElementById('admin-member-select').value); toggleAddAdminModal();">
                            <div class="mb-4">
                                <label class="block text-xs sm:text-sm mb-2">Pilih Anggota:</label>
                                <select id="admin-member-select" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="">-- Pilih Anggota --</option>
                                    ${nonAdminMembers.map(m => `
                                        <option value="${m.id}">
                                            ${m.name} - ${m.class || 'Kelas tidak diisi'} (${attendanceHistory.filter(a => a.userId === m.id).length} hadir)
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Jadikan Admin
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderRemoveAdminModal() {
            const adminMembers = members.filter(m => m.role === 'admin');
            
            return `
                <div class="modal" onclick="if(event.target === this) toggleRemoveAdminModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">üë§ Hapus Admin</h3>
                            <button onclick="toggleRemoveAdminModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="event.preventDefault(); removeAdmin(document.getElementById('remove-admin-select').value); toggleRemoveAdminModal();">
                            <div class="mb-4">
                                <label class="block text-xs sm:text-sm mb-2">Pilih Admin:</label>
                                <select id="remove-admin-select" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="">-- Pilih Admin --</option>
                                    ${adminMembers.map(m => `
                                        <option value="${m.id}">
                                            ${m.name} - ${m.class || 'Kelas tidak diisi'}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Hapus Admin
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderSetLevelModal() {
            const allMembers = members.filter(m => m.role !== 'developer');
            
            return `
                <div class="modal" onclick="if(event.target === this) toggleSetLevelModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">üìà Atur Level Anggota</h3>
                            <button onclick="toggleSetLevelModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="event.preventDefault(); setUserLevel(document.getElementById('level-member-select').value, document.getElementById('level-value').value); toggleSetLevelModal();">
                            <div class="mb-4">
                                <label class="block text-xs sm:text-sm mb-2">Pilih Anggota:</label>
                                <select id="level-member-select" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="">-- Pilih Anggota --</option>
                                    ${allMembers.map(m => `
                                        <option value="${m.id}">
                                            ${m.name} - Level ${m.level || 0} (${m.levelTitle || 'Baru'})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-xs sm:text-sm mb-2">Level Baru (1-100):</label>
                                <input type="number" id="level-value" min="1" max="100" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Atur Level
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderDevPowerModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleDevPowerModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">‚ö° Developer Power</h3>
                            <button onclick="toggleDevPowerModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-white/5 rounded-lg">
                                <h4 class="font-bold mb-2 text-green-400">Tambah Badge</h4>
                                <select id="dev-badge-user" class="w-full mb-2 p-2 rounded text-sm">
                                    <option value="">Pilih user</option>
                                    ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                                </select>
                                <select id="dev-badge-id" class="w-full mb-2 p-2 rounded text-sm">
                                    ${badges.map(b => `<option value="${b.id}">${b.name} ${b.icon}</option>`).join('')}
                                </select>
                                <button onclick="devAddBadge(document.getElementById('dev-badge-user').value, document.getElementById('dev-badge-id').value)" class="w-full bg-gradient-to-r from-green-500 to-teal-500 p-3 rounded-lg font-semibold">
                                    Tambah Badge
                                </button>
                            </div>
                            
                            <div class="p-4 bg-white/5 rounded-lg">
                                <h4 class="font-bold mb-2 text-yellow-400">Tambah Points</h4>
                                <input type="number" id="dev-points" placeholder="Jumlah points" class="w-full mb-2 p-2 rounded text-sm">
                                <select id="dev-points-user" class="w-full mb-2 p-2 rounded text-sm">
                                    <option value="">Pilih user</option>
                                    ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                                </select>
                                <button onclick="devAddPoints(document.getElementById('dev-points-user').value, document.getElementById('dev-points').value)" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 p-3 rounded-lg font-semibold">
                                    Tambah Points
                                </button>
                            </div>
                            
                            <div class="p-4 bg-white/5 rounded-lg">
                                <h4 class="font-bold mb-2 text-blue-400">Selesaikan Misi</h4>
                                <select id="dev-mission-user" class="w-full mb-2 p-2 rounded text-sm">
                                    <option value="">Pilih user</option>
                                    ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                                </select>
                                <select id="dev-mission-id" class="w-full mb-2 p-2 rounded text-sm">
                                    ${missions.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                                </select>
                                <button onclick="devCompleteMission(document.getElementById('dev-mission-user').value, document.getElementById('dev-mission-id').value)" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 p-3 rounded-lg font-semibold">
                                    Selesaikan Misi
                                </button>
                            </div>
                            
                            <div class="p-4 bg-white/5 rounded-lg">
                                <h4 class="font-bold mb-2 text-purple-400">Tambah Title</h4>
                                <input type="text" id="dev-title" placeholder="Title (contoh: The King)" class="w-full mb-2 p-2 rounded text-sm">
                                <select id="dev-title-user" class="w-full mb-2 p-2 rounded text-sm">
                                    <option value="">Pilih user</option>
                                    ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                                </select>
                                <button onclick="devAddTitle(document.getElementById('dev-title-user').value, document.getElementById('dev-title').value)" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 p-3 rounded-lg font-semibold">
                                    Tambah Title
                                </button>
                            </div>
                            
                            <div class="p-4 bg-white/5 rounded-lg">
                                <h4 class="font-bold mb-2 text-red-400">Reset Semua Data</h4>
                                <button onclick="devResetAll()" class="w-full bg-gradient-to-r from-red-500 to-pink-500 p-3 rounded-lg font-semibold">
                                    ‚ö†Ô∏è RESET SEMUA DATA ‚ö†Ô∏è
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAddProjectModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleAddProjectModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Tambah Proyek Baru</h3>
                            <button onclick="toggleAddProjectModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="addProject(event)">
                            <div class="mb-3">
                                <input type="text" id="project-name" placeholder="Nama Proyek" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="project-team" placeholder="Nama Tim" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <textarea id="project-desc" rows="3" placeholder="Deskripsi Proyek" class="w-full p-3 rounded-lg text-sm" required></textarea>
                            </div>
                            <div class="mb-3">
                                <input type="number" id="project-members" placeholder="Jumlah Anggota" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <select id="project-status" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="Development">Development</option>
                                    <option value="Selesai">Selesai</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-xs sm:text-sm mb-1">Foto Proyek</label>
                                
                                <div class="photo-preview-container mb-2">
                                    <img id="project-preview" class="photo-preview" style="display: none;">
                                    <div class="photo-preview-placeholder" id="project-placeholder">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Klik tombol upload untuk memilih foto</p>
                                    </div>
                                </div>
                                
                                <button type="button" onclick="uploadProjectPhoto()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-lg text-sm mb-2">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Foto Proyek
                                </button>
                                
                                <input type="hidden" id="project-image">
                            </div>
                            
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Tambah Proyek
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderEditProjectModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleEditProjectModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Edit Proyek</h3>
                            <button onclick="toggleEditProjectModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="updateProject(event)">
                            <div class="mb-3">
                                <input type="text" id="edit-project-name" value="${selectedProject?.name || ''}" placeholder="Nama Proyek" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="edit-project-team" value="${selectedProject?.team || ''}" placeholder="Nama Tim" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <textarea id="edit-project-desc" rows="3" placeholder="Deskripsi Proyek" class="w-full p-3 rounded-lg text-sm" required>${selectedProject?.description || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <input type="number" id="edit-project-members" value="${selectedProject?.members || 0}" placeholder="Jumlah Anggota" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-4">
                                <select id="edit-project-status" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="Development" ${selectedProject?.status === 'Development' ? 'selected' : ''}>Development</option>
                                    <option value="Selesai" ${selectedProject?.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Update Proyek
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderAddScheduleModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleAddScheduleModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Tambah Jadwal</h3>
                            <button onclick="toggleAddScheduleModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="addSchedule(event)">
                            <div class="mb-3">
                                <select id="schedule-day" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="">Pilih Hari</option>
                                    <option value="Senin">Senin</option>
                                    <option value="Selasa">Selasa</option>
                                    <option value="Rabu">Rabu</option>
                                    <option value="Kamis">Kamis</option>
                                    <option value="Jumat">Jumat</option>
                                    <option value="Sabtu">Sabtu</option>
                                    <option value="Minggu">Minggu</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="schedule-time" placeholder="Waktu (contoh: 15:30 - 17:30)" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="schedule-activity" placeholder="Kegiatan" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-4">
                                <input type="text" id="schedule-instructor" placeholder="Pembina" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Tambah Jadwal
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderEditScheduleModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleEditScheduleModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Edit Jadwal</h3>
                            <button onclick="toggleEditScheduleModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="updateSchedule(event)">
                            <div class="mb-3">
                                <select id="edit-schedule-day" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="Senin" ${selectedSchedule?.day === 'Senin' ? 'selected' : ''}>Senin</option>
                                    <option value="Selasa" ${selectedSchedule?.day === 'Selasa' ? 'selected' : ''}>Selasa</option>
                                    <option value="Rabu" ${selectedSchedule?.day === 'Rabu' ? 'selected' : ''}>Rabu</option>
                                    <option value="Kamis" ${selectedSchedule?.day === 'Kamis' ? 'selected' : ''}>Kamis</option>
                                    <option value="Jumat" ${selectedSchedule?.day === 'Jumat' ? 'selected' : ''}>Jumat</option>
                                    <option value="Sabtu" ${selectedSchedule?.day === 'Sabtu' ? 'selected' : ''}>Sabtu</option>
                                    <option value="Minggu" ${selectedSchedule?.day === 'Minggu' ? 'selected' : ''}>Minggu</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="edit-schedule-time" value="${selectedSchedule?.time || ''}" placeholder="Waktu" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="edit-schedule-activity" value="${selectedSchedule?.activity || ''}" placeholder="Kegiatan" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-4">
                                <input type="text" id="edit-schedule-instructor" value="${selectedSchedule?.instructor || ''}" placeholder="Pembina" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Update Jadwal
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderAddNotificationModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleAddNotificationModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Buat Notifikasi</h3>
                            <button onclick="toggleAddNotificationModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="addNotification(event)">
                            <div class="mb-3">
                                <input type="text" id="notif-title" placeholder="Judul Notifikasi" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <textarea id="notif-message" rows="4" placeholder="Isi Notifikasi" class="w-full p-3 rounded-lg text-sm" required></textarea>
                            </div>
                            <div class="mb-3">
                                <select id="notif-type" class="w-full p-3 rounded-lg text-sm" required>
                                    <option value="info">Informasi</option>
                                    <option value="warning">Peringatan</option>
                                    <option value="success">Pengumuman</option>
                                    <option value="event">Event</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Kirim Notifikasi
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderAddTeacherModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleAddTeacherModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Tambah Pembina</h3>
                            <button onclick="toggleAddTeacherModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="addTeacher(event)">
                            <div class="mb-3">
                                <input type="text" id="teacher-name" placeholder="Nama Lengkap" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="teacher-role" placeholder="Jabatan" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="email" id="teacher-email" placeholder="Email" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <textarea id="teacher-bio" rows="3" placeholder="Bio Singkat" class="w-full p-3 rounded-lg text-sm" required></textarea>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="teacher-expertise" placeholder="Keahlian (pisahkan dengan koma)" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="url" id="teacher-photo" placeholder="URL Foto" class="w-full p-3 rounded-lg text-sm">
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Tambah Pembina
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderEditTeacherModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleEditTeacherModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Edit Pembina</h3>
                            <button onclick="toggleEditTeacherModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <form onsubmit="updateTeacher(event)">
                            <div class="mb-3">
                                <input type="text" id="edit-teacher-name" value="${selectedTeacher?.name || ''}" placeholder="Nama Lengkap" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="edit-teacher-role" value="${selectedTeacher?.role || ''}" placeholder="Jabatan" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <div class="mb-3">
                                <textarea id="edit-teacher-bio" rows="3" placeholder="Bio Singkat" class="w-full p-3 rounded-lg text-sm" required>${selectedTeacher?.bio || ''}</textarea>
                            </div>
                            <div class="mb-4">
                                <input type="text" id="edit-teacher-expertise" value="${selectedTeacher?.expertise ? selectedTeacher.expertise.join(', ') : ''}" placeholder="Keahlian (pisahkan dengan koma)" class="w-full p-3 rounded-lg text-sm" required>
                            </div>
                            <button type="submit" class="w-full gradient-bg p-3 rounded-lg font-semibold text-sm sm:text-base">
                                Update Pembina
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderAttendanceHistoryModal() {
            return `
                <div class="modal" onclick="if(event.target === this) toggleAttendanceHistoryModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">Semua Riwayat Absensi</h3>
                            <button onclick="toggleAttendanceHistoryModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <div class="max-h-96 overflow-y-auto">
                            <table class="attendance-table w-full">
                                <thead>
                                    <tr>
                                        <th class="p-2 text-xs">Tanggal</th>
                                        <th class="p-2 text-xs">Jam</th>
                                        <th class="p-2 text-xs">Nama</th>
                                        <th class="p-2 text-xs">Kelas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${attendanceHistory.map(a => `
                                        <tr>
                                            <td class="p-2 text-xs">${a.date}</td>
                                            <td class="p-2 text-xs">${a.time}</td>
                                            <td class="p-2 text-xs">${a.name}</td>
                                            <td class="p-2 text-xs">${a.class || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <button onclick="exportAttendanceToExcel()" class="w-full mt-4 bg-green-600 p-3 rounded-lg font-semibold">
                            <i class="fas fa-download mr-2"></i>Export ke Excel
                        </button>
                    </div>
                </div>
            `;
        }

        function renderLeaderboardModal() {
            calculateLeaderboard();
            
            return `
                <div class="modal" onclick="if(event.target === this) toggleLeaderboardModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl sm:text-2xl font-bold">üèÜ Peringkat Anggota</h3>
                            <button onclick="toggleLeaderboardModal()" class="text-2xl hover:text-gray-400">&times;</button>
                        </div>
                        
                        <div class="space-y-3">
                            ${leaderboardData.length > 0 ? leaderboardData.slice(0, 10).map((member, index) => {
                                let medalClass = '';
                                if (index === 0) medalClass = 'medal-1';
                                else if (index === 1) medalClass = 'medal-2';
                                else if (index === 2) medalClass = 'medal-3';
                                
                                return `
                                    <div class="flex items-center p-3 bg-white/5 rounded-lg hover-scale cursor-pointer" onclick="viewMemberProfile('${member.id}')">
                                        <div class="w-8 text-center font-bold ${medalClass} p-2 rounded-full mr-3">
                                            #${index + 1}
                                        </div>
                                        <img src="${member.photo}" class="w-10 h-10 rounded-full border-2 border-blue-400 mr-3"
                                             onerror="this.src='https://ui-avatars.com/api/?name=${member.name}&background=00d4ff&color=fff'">
                                        <div class="flex-1">
                                            <p class="font-semibold text-sm">${member.name}</p>
                                            <p class="text-xs text-gray-400">${member.class || '-'}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-blue-400 font-bold">${member.attendance}</p>
                                            <p class="text-xs text-gray-400">hadir</p>
                                        </div>
                                        <div class="ml-3 text-right">
                                            <p class="text-yellow-400 font-bold">${member.level.icon} ${member.level.level}</p>
                                            <p class="text-xs text-gray-400">level</p>
                                        </div>
                                    </div>
                                `;
                            }).join('') : `
                                <p class="text-gray-400 text-center py-8">Belum ada data leaderboard</p>
                            `}
                        </div>
                        
                        <button onclick="toggleLeaderboardModal()" class="w-full mt-4 bg-blue-600 p-3 rounded-lg font-semibold">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
        }

        // ==================== SERTIFIKAT ====================
        window.printCertificate = async function(memberId) {
            if (!currentUser) {
                showToast('Silakan login dulu', 'error');
                return;
            }
            
            const member = members.find(m => m.id === memberId) || userData;
            if (!member) {
                showToast('Data anggota tidak ditemukan', 'error');
                return;
            }
            
            const totalHadir = attendanceHistory.filter(a => a.userId === member.id).length;
            const level = member.level || 0;
            const levelIcon = member.levelIcon || 'üÜï';
            
            Swal.fire({
                title: 'Membuat Sertifikat...',
                html: 'Mohon tunggu',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const template = document.getElementById('certificate-template');
                template.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <img src="https://ui-avatars.com/api/?name=SMK+TI+BALI+GLOBAL&background=00d4ff&color=fff&size=200" 
                             style="width: 150px; margin-bottom: 20px;">
                        
                        <h1 style="font-size: 48px; color: #0a5cff; margin: 20px 0;">SERTIFIKAT KEHADIRAN</h1>
                        
                        <p style="font-size: 18px; color: #666;">Diberikan kepada:</p>
                        <h2 style="font-size: 36px; color: #000; margin: 20px 0;">${member.name}</h2>
                        
                        <p style="font-size: 18px; color: #666;">Kelas: ${member.class || '-'}</p>
                        <p style="font-size: 18px; color: #666;">Sebagai anggota aktif</p>
                        
                        <div style="margin: 30px 0; padding: 20px; background: #f5f5f5; border-radius: 10px;">
                            <p style="font-size: 24px; color: #00d4ff; font-weight: bold;">${totalHadir} Kali Hadir</p>
                            <p style="font-size: 16px; color: #666;">${levelIcon} Level ${level}</p>
                            <p style="font-size: 16px; color: #666;">Badges: ${userBadges[member.id]?.badges?.length || 0}</p>
                            <p style="font-size: 16px; color: #666;">Points: ‚≠ê ${userPoints[member.id] || 0}</p>
                            <p style="font-size: 16px; color: #666;">Periode: ${moment().format('MMMM YYYY')}</p>
                        </div>
                        
                        <div style="margin-top: 50px; display: flex; justify-content: space-around;">
                            <div>
                                <p style="border-top: 2px solid #000; width: 200px; margin: 0 auto; padding-top: 10px;">
                                    Pembina Ekskul
                                </p>
                            </div>
                            <div>
                                <p style="border-top: 2px solid #000; width: 200px; margin: 0 auto; padding-top: 10px;">
                                    Ketua Ekskul
                                </p>
                            </div>
                        </div>
                        
                        <p style="margin-top: 40px; font-size: 14px; color: #999;">
                            ${ekstraData.school}<br>
                            ${moment().format('DD MMMM YYYY')}
                        </p>
                    </div>
                `;
                
                const canvas = await html2canvas(template);
                const imgData = canvas.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [800, 600]
                });
                
                pdf.addImage(imgData, 'PNG', 0, 0, 800, 600);
                pdf.save(`Sertifikat_${member.name.replace(/ /g, '_')}.pdf`);
                
                Swal.close();
                showToast('Sertifikat berhasil dibuat!');
                
            } catch (error) {
                console.error('Error creating certificate:', error);
                Swal.fire('Error', 'Gagal membuat sertifikat', 'error');
            }
        };

        // ==================== EXPORT ====================
        window.exportAttendanceToExcel = function() {
            try {
                if (typeof XLSX === 'undefined') {
                    showToast('Library Excel tidak tersedia', 'error');
                    return;
                }
                
                if (attendanceHistory.length === 0) {
                    showToast('Tidak ada data untuk di-export', 'warning');
                    return;
                }
                
                const exportData = attendanceHistory.map(a => ({
                    'Tanggal': a.date || '-',
                    'Hari': a.day || moment(a.date).format('dddd') || '-',
                    'Jam': a.time || '-',
                    'Nama': a.name || '-',
                    'Kelas': a.class || '-'
                }));

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                XLSX.utils.book_append_sheet(wb, ws, "Riwayat Absensi");
                XLSX.writeFile(wb, `riwayat_absensi_${moment().format('YYYY-MM-DD_HH-mm')}.xlsx`);
                
                showToast(`Berhasil export ${exportData.length} data absensi`);
            } catch (error) {
                console.error('Error exporting:', error);
                showToast('Gagal export data: ' + error.message, 'error');
            }
        };

        // ==================== DELETE FUNCTIONS ====================
        window.deleteMember = async (memberId) => {
            if (userRole !== 'developer' && userRole !== 'admin') {
                showToast('Anda tidak memiliki akses!', 'error');
                return;
            }
            
            const result = await Swal.fire({
                title: 'Hapus Anggota?',
                text: 'Data yang dihapus tidak dapat dikembalikan!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                try {
                    await db.collection('members').doc(memberId).delete();
                    
                    const attendanceSnapshot = await db.collection('attendance')
                        .where('userId', '==', memberId)
                        .get();
                    
                    const batch = db.batch();
                    attendanceSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    showToast('Anggota berhasil dihapus');
                } catch (error) {
                    console.error('Error deleting member:', error);
                    showToast('Gagal menghapus: ' + error.message, 'error');
                }
            }
        };

        window.deleteProject = async (projectId) => {
            if (userRole !== 'developer' && userRole !== 'admin') {
                showToast('Anda tidak memiliki akses!', 'error');
                return;
            }
            
            const result = await Swal.fire({
                title: 'Hapus Proyek?',
                text: 'Data yang dihapus tidak dapat dikembalikan!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                try {
                    await db.collection('projects').doc(projectId).delete();
                    showToast('Proyek berhasil dihapus');
                } catch (error) {
                    showToast('Gagal menghapus: ' + error.message, 'error');
                }
            }
        };

        window.deleteSchedule = async (scheduleId) => {
            if (userRole !== 'developer' && userRole !== 'admin') {
                showToast('Anda tidak memiliki akses!', 'error');
                return;
            }
            
            const result = await Swal.fire({
                title: 'Hapus Jadwal?',
                text: 'Data yang dihapus tidak dapat dikembalikan!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                try {
                    await db.collection('schedules').doc(scheduleId).delete();
                    showToast('Jadwal berhasil dihapus');
                } catch (error) {
                    showToast('Gagal menghapus: ' + error.message, 'error');
                }
            }
        };

        window.deleteTeacher = async (teacherId) => {
            if (userRole !== 'developer' && userRole !== 'admin') {
                showToast('Anda tidak memiliki akses!', 'error');
                return;
            }
            
            const result = await Swal.fire({
                title: 'Hapus Pembina?',
                text: 'Data yang dihapus tidak dapat dikembalikan!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                try {
                    await db.collection('teachers').doc(teacherId).delete();
                    showToast('Pembina berhasil dihapus');
                } catch (error) {
                    showToast('Gagal menghapus: ' + error.message, 'error');
                }
            }
        };

        window.deleteAttendance = async (attendanceId) => {
            if (userRole !== 'developer' && userRole !== 'admin') {
                showToast('Anda tidak memiliki akses!', 'error');
                return;
            }
            
            const result = await Swal.fire({
                title: 'Hapus Data Absensi?',
                text: 'Data yang dihapus tidak dapat dikembalikan!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                try {
                    await db.collection('attendance').doc(attendanceId).delete();
                    showToast('Data absensi berhasil dihapus');
                } catch (error) {
                    showToast('Gagal menghapus: ' + error.message, 'error');
                }
            }
        };

        // ==================== ADD FUNCTIONS ====================
        window.addProject = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('project-name').value;
            const team = document.getElementById('project-team').value;
            const description = document.getElementById('project-desc').value;
            const members = parseInt(document.getElementById('project-members').value);
            const status = document.getElementById('project-status').value;
            const imageUrl = document.getElementById('project-image').value;
            
            try {
                let image = imageUrl || 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e';
                
                await db.collection('projects').add({
                    name,
                    team,
                    description,
                    members,
                    status,
                    image,
                    createdAt: new Date(),
                    createdBy: currentUser?.uid,
                    createdByName: userData?.name
                });
                
                showAddProjectModal = false;
                showToast('Proyek berhasil ditambahkan!');
                
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        };

        window.addSchedule = async (e) => {
            e.preventDefault();
            
            const day = document.getElementById('schedule-day').value;
            const time = document.getElementById('schedule-time').value;
            const activity = document.getElementById('schedule-activity').value;
            const instructor = document.getElementById('schedule-instructor').value;
            
            try {
                await db.collection('schedules').add({
                    day,
                    time,
                    activity,
                    instructor,
                    createdAt: new Date(),
                    createdBy: currentUser?.uid
                });
                
                showAddScheduleModal = false;
                showToast('Jadwal berhasil ditambahkan!');
                
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        };

        window.addNotification = async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('notif-title').value;
            const message = document.getElementById('notif-message').value;
            const type = document.getElementById('notif-type').value;
            
            try {
                await db.collection('notifications').add({
                    title,
                    message,
                    type,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser?.uid,
                    createdByName: userData?.name || currentUser?.displayName,
                    readBy: []
                });
                
                showAddNotificationModal = false;
                showToast('Notifikasi berhasil dikirim!');
                
            } catch (error) {
                console.error('Error adding notification:', error);
                showToast('Gagal: ' + error.message, 'error');
            }
        };

        window.addTeacher = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('teacher-name').value;
            const role = document.getElementById('teacher-role').value;
            const email = document.getElementById('teacher-email').value;
            const bio = document.getElementById('teacher-bio').value;
            const expertiseStr = document.getElementById('teacher-expertise').value;
            const photoUrl = document.getElementById('teacher-photo').value;
            
            const expertise = expertiseStr.split(',').map(s => s.trim());
            
            try {
                let photo = photoUrl || `https://ui-avatars.com/api/?name=${name.replace(/ /g, '+')}&background=00d4ff&color=fff`;
                
                await db.collection('teachers').add({
                    name,
                    role,
                    email,
                    bio,
                    expertise,
                    photo,
                    createdAt: new Date()
                });
                
                showAddTeacherModal = false;
                showToast('Pembina berhasil ditambahkan!');
                
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        };

        // ==================== EDIT FUNCTIONS ====================
        window.editProject = (project) => {
            selectedProject = project;
            showEditProjectModal = true;
            renderMainContent();
        };

        window.updateProject = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('edit-project-name').value;
            const team = document.getElementById('edit-project-team').value;
            const description = document.getElementById('edit-project-desc').value;
            const members = parseInt(document.getElementById('edit-project-members').value);
            const status = document.getElementById('edit-project-status').value;
            
            try {
                await db.collection('projects').doc(selectedProject.id).update({
                    name,
                    team,
                    description,
                    members,
                    status,
                    updatedAt: new Date()
                });
                
                showEditProjectModal = false;
                selectedProject = null;
                showToast('Proyek berhasil diupdate');
                
            } catch (error) {
                showToast('Gagal update: ' + error.message, 'error');
            }
        };

        window.editSchedule = (schedule) => {
            selectedSchedule = schedule;
            showEditScheduleModal = true;
            renderMainContent();
        };

        window.updateSchedule = async (e) => {
            e.preventDefault();
            
            const day = document.getElementById('edit-schedule-day').value;
            const time = document.getElementById('edit-schedule-time').value;
            const activity = document.getElementById('edit-schedule-activity').value;
            const instructor = document.getElementById('edit-schedule-instructor').value;
            
            try {
                await db.collection('schedules').doc(selectedSchedule.id).update({
                    day,
                    time,
                    activity,
                    instructor,
                    updatedAt: new Date()
                });
                
                showEditScheduleModal = false;
                selectedSchedule = null;
                showToast('Jadwal berhasil diupdate');
                
            } catch (error) {
                showToast('Gagal update: ' + error.message, 'error');
            }
        };

        window.editTeacher = (teacher) => {
            selectedTeacher = teacher;
            showEditTeacherModal = true;
            renderMainContent();
        };

        window.updateTeacher = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('edit-teacher-name').value;
            const role = document.getElementById('edit-teacher-role').value;
            const bio = document.getElementById('edit-teacher-bio').value;
            const expertiseStr = document.getElementById('edit-teacher-expertise').value;
            
            const expertise = expertiseStr.split(',').map(s => s.trim());
            
            try {
                await db.collection('teachers').doc(selectedTeacher.id).update({
                    name,
                    role,
                    bio,
                    expertise,
                    updatedAt: new Date()
                });
                
                showEditTeacherModal = false;
                selectedTeacher = null;
                showToast('Pembina berhasil diupdate');
                
            } catch (error) {
                showToast('Gagal update: ' + error.message, 'error');
            }
        };

        // ==================== CHART ====================
        function renderAttendanceChart() {
            const chartContainer = document.getElementById('attendance-chart-container');
            if (!chartContainer) return;
            
            const monthlyData = {};
            attendanceHistory.forEach(a => {
                const month = moment(a.date).format('MMMM YYYY');
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const labels = Object.keys(monthlyData).slice(-6);
            const data = Object.values(monthlyData).slice(-6);
            
            if (attendanceChart) {
                attendanceChart.destroy();
            }
            
            const ctx = document.getElementById('attendance-chart').getContext('2d');
            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Kehadiran',
                        data: data,
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#fff' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#fff', maxRotation: 45 }
                        }
                    }
                }
            });
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            AOS.init({ duration: 800, once: true, offset: 50 });

            particlesJS('particles-js', {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: '#00d4ff' },
                    shape: { type: 'circle' },
                    opacity: { value: 0.5, random: false },
                    size: { value: 3, random: true },
                    line_linked: { enable: true, distance: 150, color: '#00d4ff', opacity: 0.4, width: 1 },
                    move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
                    modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
                },
                retina_detect: true
            });

            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                const progressEl = document.getElementById('loading-progress');
                if (progressEl) progressEl.textContent = progress + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen) {
                            loadingScreen.style.opacity = '0';
                            setTimeout(() => {
                                loadingScreen.style.display = 'none';
                            }, 300);
                        }
                    }, 300);
                }
            }, 30);

            // Setup realtime listeners
            setupRealtimeListeners();
            
            renderMainContent();
        });
    </script>
</body>
</html>
